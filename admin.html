<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin Dashboard — SmartInvest</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .tab-btn { padding: 0.5rem 1rem; border: none; background: #e5e7eb; cursor: pointer; }
    .tab-btn.active { background: #2563eb; color: white; }
  </style>
</head>
<body class="p-4 bg-gray-100">
  <div class="max-w-6xl mx-auto">
    <!-- Header -->
    <div class="bg-white p-6 rounded shadow mb-4">
      <h1 class="text-3xl font-bold">Admin Dashboard</h1>
      <p class="text-gray-600">Manage users, payments, files, messages, and premium access</p>
    </div>

    <!-- Tabs Navigation -->
    <div class="flex gap-2 mb-4 flex-wrap bg-white p-2 rounded shadow">
      <button class="tab-btn active" onclick="switchTab('dashboard')">Dashboard</button>
      <button class="tab-btn" onclick="switchTab('users')">Users & Sessions</button>
      <button class="tab-btn" onclick="switchTab('premium')">Premium Access</button>
      <button class="tab-btn" onclick="switchTab('files')">File Manager</button>
      <button class="tab-btn" onclick="switchTab('messages')">Support Messages</button>
      <button class="tab-btn" onclick="switchTab('payments')">Payments</button>
      <button class="tab-btn" onclick="switchTab('email')">Email Tools</button>
    </div>

    <!-- Dashboard Tab -->
    <div id="dashboard" class="tab-content active bg-white p-6 rounded shadow mb-4">
      <h2 class="text-2xl font-bold mb-4">Dashboard Overview</h2>
      <div class="grid grid-cols-4 gap-4">
        <div class="bg-blue-50 p-4 rounded border">
          <div class="text-gray-600 text-sm">Total Users</div>
          <div id="stat-users" class="text-3xl font-bold">-</div>
        </div>
        <div class="bg-green-50 p-4 rounded border">
          <div class="text-gray-600 text-sm">Premium Users</div>
          <div id="stat-premium" class="text-3xl font-bold">-</div>
        </div>
        <div class="bg-purple-50 p-4 rounded border">
          <div class="text-gray-600 text-sm">Files Uploaded</div>
          <div id="stat-files" class="text-3xl font-bold">-</div>
        </div>
        <div class="bg-orange-50 p-4 rounded border">
          <div class="text-gray-600 text-sm">Pending Messages</div>
          <div id="stat-messages" class="text-3xl font-bold">-</div>
        </div>
      </div>
      <button onclick="refreshDashboard()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded">Refresh Stats</button>
    </div>

    <!-- Users & Sessions Tab -->
    <div id="users" class="tab-content bg-white p-6 rounded shadow mb-4">
      <h2 class="text-2xl font-bold mb-4">Users & Active Sessions</h2>
      
      <div class="mb-4">
        <h3 class="font-semibold mb-2">Registered Users</h3>
        <div class="flex gap-2 mb-2">
          <input type="text" id="userSearch" placeholder="Search by email or name..." class="flex-1 border rounded p-2">
          <button onclick="searchUsers()" class="bg-blue-600 text-white px-4 py-2 rounded">Search</button>
          <button onclick="loadAllUsers()" class="bg-gray-600 text-white px-4 py-2 rounded">Load All</button>
        </div>
        <div id="usersList" class="text-sm text-gray-600">Click "Load All" to view users...</div>
      </div>

      <div class="mb-4 border-t pt-4">
        <h3 class="font-semibold mb-2">Active Sessions</h3>
        <div id="sessionsList" class="text-sm text-gray-600">Loading sessions...</div>
        <button onclick="loadActiveSessions()" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded">Refresh Sessions</button>
      </div>
    </div>

    <!-- Premium Access Tab -->
    <div id="premium" class="tab-content bg-white p-6 rounded shadow mb-4">
      <!doctype html>
      <html lang="en">
      <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <title>SmartInvest Dashboard Hub</title>
        <meta http-equiv="refresh" content="0; url=/?dashboard=admin#dashboard-hub">
        <style>
          body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            min-height: 100vh;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8fafc;
            color: #0f172a;
          }
          .card {
            background: #fff;
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 20px 50px rgba(15, 23, 42, 0.15);
            max-width: 420px;
            text-align: center;
            line-height: 1.5;
          }
          a {
            color: #2563eb;
            text-decoration: none;
            font-weight: 600;
          }
          a:hover {
            text-decoration: underline;
          }
        </style>
      </head>
      <body>
        <main class="card">
          <p>Admin controls now live inside the SmartInvest homepage.</p>
          <p>Redirecting you to the unified dashboard hub…</p>
          <p><a href="/?dashboard=admin#dashboard-hub">Continue to homepage</a></p>
        </main>
        <script>
          try {
            window.location.replace('/?dashboard=admin#dashboard-hub');
          } catch (e) {
            window.location.href = '/?dashboard=admin#dashboard-hub';
          }
        </script>
      </body>
      </html>

        const data = await res.json();
        const status = document.getElementById('uploadStatus');

        if (data.success) {
          status.textContent = '✓ File uploaded successfully';
          status.className = 'text-sm text-green-600';
          document.getElementById('fileTitle').value = '';
          document.getElementById('filePrice').value = '0';
          document.getElementById('fileDescription').value = '';
          fileInput.value = '';
          setTimeout(loadFiles, 1000);
        } else {
          status.textContent = '✗ Upload failed: ' + (data.error || '');
          status.className = 'text-sm text-red-600';
        }
      } catch (e) {
        document.getElementById('uploadStatus').textContent = '✗ Error: ' + e.message;
        document.getElementById('uploadStatus').className = 'text-sm text-red-600';
      }
    }

    async function loadFiles() {
      try {
        const res = await fetch('/api/admin/files');
        const data = await res.json();
        const list = document.getElementById('filesList');

        if (!data.success || !data.files.length) {
          list.innerHTML = '<div class="text-gray-600">No files uploaded.</div>';
          return;
        }

        const rows = data.files.map(f => `
          <div class="border rounded p-2 mb-2">
            <div class="flex justify-between items-start">
              <div>
                <strong>${f.title}</strong><br>
                <small class="text-gray-600">Price: $${f.price}</small><br>
                <small class="text-xs text-gray-500">${f.originalName}</small>
              </div>
              <div class="space-x-1">
                <button onclick="togglePublish('${f.id}',${f.published})" class="bg-gray-500 text-white px-2 py-1 rounded text-xs">${f.published ? 'Unpublish' : 'Publish'}</button>
                <button onclick="deleteFile('${f.id}')" class="bg-red-600 text-white px-2 py-1 rounded text-xs">Delete</button>
              </div>
            </div>
          </div>
        `).join('');

        list.innerHTML = rows;
      } catch (e) {
        document.getElementById('filesList').innerHTML = '<div class="text-red-600">Error loading files</div>';
      }
    }

    async function togglePublish(id, current) {
      try {
        const res = await fetch(`/api/admin/files/${id}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ published: !current })
        });

        const data = await res.json();
        if (data.success) loadFiles();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    async function deleteFile(id) {
      if (!confirm('Delete this file?')) return;

      try {
        const res = await fetch(`/api/admin/files/${id}`, { method: 'DELETE' });
        const data = await res.json();

        if (data.success) {
          alert('File deleted');
          loadFiles();
        } else {
          alert('Error: ' + (data.error || 'Failed'));
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    function exportFilesList() {
      alert('Export functionality to be implemented');
    }

    // === MESSAGES ===
    async function loadMessages() {
      try {
        const res = await fetch('/api/admin/messages');
        const data = await res.json();
        const list = document.getElementById('messagesList');

        if (!data.success || !data.messages.length) {
          list.innerHTML = '<div class="text-gray-600">No messages.</div>';
          return;
        }

        const rows = data.messages.map(m => `
          <div class="border rounded p-3 bg-gray-50">
            <div class="flex justify-between">
              <div>
                <strong>${m.name}</strong><br>
                <small class="text-gray-600">${m.email}</small>
              </div>
              <small class="text-gray-500">${m.createdAt}</small>
            </div>
            <div class="mt-2 text-sm">${m.message}</div>
            ${(m.replies || []).map(r => `
              <div class="mt-2 p-2 bg-white border-l-4 border-blue-600">
                <strong class="text-blue-600">Admin Reply:</strong><br>
                <small class="text-gray-500">${r.at}</small>
                <div class="text-sm mt-1">${r.message}</div>
              </div>
            `).join('')}
            <div class="mt-2 flex gap-2">
              <input id="reply_${m.id}" type="text" placeholder="Your reply..." class="flex-1 border rounded p-2 text-sm">
              <button onclick="replyMessage('${m.id}')" class="bg-blue-600 text-white px-3 py-1 rounded text-sm">Reply</button>
            </div>
          </div>
        `).join('');

        list.innerHTML = rows;
      } catch (e) {
        document.getElementById('messagesList').innerHTML = '<div class="text-red-600">Error loading messages</div>';
      }
    }

    async function replyMessage(id) {
      const input = document.getElementById(`reply_${id}`);
      const text = input.value.trim();

      if (!text) return alert('Enter a reply');

      try {
        const res = await fetch(`/api/admin/messages/${id}/reply`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reply: text })
        });

        const data = await res.json();
        if (data.success) {
          input.value = '';
          loadMessages();
        } else {
          alert('Error: ' + (data.error || 'Failed'));
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    function refreshMessages() {
      loadMessages();
    }

    // === PAYMENTS ===
    async function loadKCBTransfers() {
      try {
        const res = await fetch('/api/admin/kcb-transfers');
        const data = await res.json();
        const list = document.getElementById('kcbTransfersList');

        if (!data.success || !data.transfers.length) {
          list.innerHTML = '<div class="text-gray-600">No transfers found.</div>';
          return;
        }

        const rows = data.transfers.map(t => `
          <div class="border rounded p-2 mb-2 text-sm">
            <div class="flex justify-between">
              <div>
                <strong>${t.name}</strong> (${t.email})<br>
                <small class="text-gray-600">KES ${t.amount} - Ref: ${t.reference || 'N/A'}</small>
              </div>
              <div class="text-right">
                <span class="text-xs bg-${t.status === 'paid' ? 'green' : 'yellow'}-100 px-2 py-1 rounded">${t.status}</span><br>
                <small class="text-gray-500">${t.timestamp}</small>
              </div>
            </div>
            ${t.status !== 'paid' ? `<button onclick="markPaid('${t.timestamp}')" class="mt-1 bg-green-600 text-white px-2 py-1 rounded text-xs">Mark Paid</button>` : ''}
          </div>
        `).join('');

        list.innerHTML = rows;
      } catch (e) {
        document.getElementById('kcbTransfersList').innerHTML = '<div class="text-red-600">Error loading transfers</div>';
      }
    }

    async function markPaid(ts) {
      const note = prompt('Optional note for this transfer:');
      
      try {
        const res = await fetch('/api/admin/kcb/mark-paid', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ timestamp: ts, note })
        });

        const data = await res.json();
        if (data.success) {
          alert('Transfer marked as paid');
          loadKCBTransfers();
        } else {
          alert('Error: ' + (data.error || 'Failed'));
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    async function exportKCBCSV() {
      try {
        const res = await fetch('/api/admin/kcb-export');
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'kcb-transfers.csv';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (e) {
        alert('Export failed: ' + e.message);
      }
    }

    async function reconcileBankEntries() {
      const txt = document.getElementById('reconcileData').value.trim();
      if (!txt) return alert('Paste JSON array');

      let arr;
      try {
        arr = JSON.parse(txt);
      } catch (e) {
        return alert('Invalid JSON: ' + e.message);
      }

      try {
        const res = await fetch('/api/admin/kcb/reconcile', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ entries: arr })
        });

        const data = await res.json();
        const result = document.getElementById('reconcileResult');

        if (data.success) {
          result.textContent = `✓ Matched: ${data.summary.matched}, Unmatched: ${data.summary.unmatched}`;
          result.className = 'text-sm text-green-600 mt-2';
          loadKCBTransfers();
        } else {
          result.textContent = '✗ Error: ' + (data.error || '');
          result.className = 'text-sm text-red-600 mt-2';
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    async function requestPaymentReview() {
      const paymentId = document.getElementById('paymentId').value.trim();
      if (!paymentId) return alert('Enter payment ID');

      try {
        const res = await fetch('/api/admin/payment-review', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ paymentId })
        });

        const data = await res.json();
        const status = document.getElementById('reviewStatus');

        if (data.success) {
          status.textContent = `✓ Review requested for payment ${paymentId}`;
          status.className = 'text-sm text-green-600';
          document.getElementById('paymentId').value = '';
        } else {
          status.textContent = '✗ Error: ' + (data.error || 'Failed');
          status.className = 'text-sm text-red-600';
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    async function loadPaymentsLedger() {
      try {
        const res = await fetch('/api/admin/payments');
        const data = await res.json();
        const list = document.getElementById('paymentsLedger');

        if (!data.success) {
          list.innerHTML = '<div class="text-red-600">Error loading payments ledger.</div>';
          return;
        }

        if (!data.payments.length) {
          list.innerHTML = '<div class="text-gray-600">No payments recorded yet.</div>';
          return;
        }

        const rows = data.payments.map(p => `
          <div class="bg-white border rounded p-3 mb-2">
            <div class="flex justify-between items-start">
              <div>
                <div class="text-xs uppercase tracking-wide text-gray-500">${p.provider}</div>
                <div class="font-semibold">${p.amount ? p.amount : 'N/A'} ${p.currency || ''}</div>
                <div class="text-xs text-gray-600">${p.fileTitle ? 'File: ' + p.fileTitle : ''}</div>
              </div>
              <div class="text-right">
                <span class="text-xs px-2 py-1 rounded bg-${p.status === 'success' || p.status === 'paid' ? 'green' : p.status === 'pending' ? 'yellow' : 'red'}-100">${p.status}</span><br>
                <small class="text-gray-500">${p.createdAt || ''}</small>
              </div>
            </div>
            <div class="text-xs text-gray-700 mt-2">User: ${p.email || 'N/A'} ${p.phone ? '(' + p.phone + ')' : ''}</div>
            <div class="text-xs text-gray-600">Reference: ${p.reference || 'N/A'} ${p.receipt ? ' • Receipt: ' + p.receipt : ''}</div>
            ${p.note ? `<div class="text-xs text-gray-600">Note: ${p.note}</div>` : ''}
          </div>
        `).join('');

        list.innerHTML = rows;
      } catch (e) {
        document.getElementById('paymentsLedger').innerHTML = '<div class="text-red-600">Error loading payments</div>';
      }
    }

    // === EMAIL TOOLS ===
    async function sendEmail() {
      const to = document.getElementById('emailTo').value;
      const subject = document.getElementById('emailSubject').value;
      const body = document.getElementById('emailBody').value;

      if (!to || !subject || !body) return alert('Fill all fields');

      try {
        const res = await fetch('/api/admin/send-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ to, subject, body })
        });

        const data = await res.json();
        const status = document.getElementById('emailStatus');

        if (data.success) {
          status.textContent = '✓ Email sent to ' + to;
          status.className = 'text-sm text-green-600';
          document.getElementById('emailTo').value = '';
          document.getElementById('emailSubject').value = '';
          document.getElementById('emailBody').value = '';
        } else {
          status.textContent = '✗ Error: ' + (data.error || 'Failed');
          status.className = 'text-sm text-red-600';
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    async function sendBulkEmail() {
      const subject = document.getElementById('bulkSubject').value;
      const body = document.getElementById('bulkBody').value;
      const recipients = document.getElementById('bulkRecipients').value;

      if (!subject || !body || !recipients) return alert('Fill all fields');

      try {
        const res = await fetch('/api/admin/send-bulk-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ subject, body, recipients })
        });

        const data = await res.json();
        const status = document.getElementById('bulkStatus');

        if (data.success) {
          status.textContent = `✓ Email sent to ${data.sentCount} recipients`;
          status.className = 'text-sm text-green-600';
          document.getElementById('bulkSubject').value = '';
          document.getElementById('bulkBody').value = '';
          document.getElementById('bulkRecipients').value = '';
        } else {
          status.textContent = '✗ Error: ' + (data.error || 'Failed');
          status.className = 'text-sm text-red-600';
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    // Initial load
    window.addEventListener('load', () => {
      refreshDashboard();
    });
  </script>
</body>
</html>
