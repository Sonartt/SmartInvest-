<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin Dashboard — SmartInvest</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .tab-btn { padding: 0.5rem 1rem; border: none; background: #e5e7eb; cursor: pointer; }
    .tab-btn.active { background: #2563eb; color: white; }
  </style>
</head>
<body class="p-4 bg-gray-100">
  <div class="max-w-6xl mx-auto">
    <!-- Header -->
    <div class="bg-white p-6 rounded shadow mb-4">
      <h1 class="text-3xl font-bold">Admin Dashboard</h1>
      <p class="text-gray-600">Manage users, payments, files, messages, and premium access</p>
    </div>

    <!-- Tabs Navigation -->
    <div class="flex gap-2 mb-4 flex-wrap bg-white p-2 rounded shadow">
      <button class="tab-btn active" onclick="switchTab('dashboard')">Dashboard</button>
      <button class="tab-btn" onclick="switchTab('users')">Users & Sessions</button>
      <button class="tab-btn" onclick="switchTab('premium')">Premium Access</button>
      <button class="tab-btn" onclick="switchTab('files')">File Manager</button>
      <button class="tab-btn" onclick="switchTab('messages')">Support Messages</button>
      <button class="tab-btn" onclick="switchTab('payments')">Payments</button>
      <button class="tab-btn" onclick="switchTab('email')">Email Tools</button>
    </div>

    <!-- Dashboard Tab -->
    <div id="dashboard" class="tab-content active bg-white p-6 rounded shadow mb-4">
      <h2 class="text-2xl font-bold mb-4">Dashboard Overview</h2>
      <div class="grid grid-cols-4 gap-4">
        <div class="bg-blue-50 p-4 rounded border">
          <div class="text-gray-600 text-sm">Total Users</div>
          <div id="stat-users" class="text-3xl font-bold">-</div>
        </div>
        <div class="bg-green-50 p-4 rounded border">
          <div class="text-gray-600 text-sm">Premium Users</div>
          <div id="stat-premium" class="text-3xl font-bold">-</div>
        </div>
        <div class="bg-purple-50 p-4 rounded border">
          <div class="text-gray-600 text-sm">Files Uploaded</div>
          <div id="stat-files" class="text-3xl font-bold">-</div>
        </div>
        <div class="bg-orange-50 p-4 rounded border">
          <div class="text-gray-600 text-sm">Pending Messages</div>
          <div id="stat-messages" class="text-3xl font-bold">-</div>
        </div>
      </div>
      <button onclick="refreshDashboard()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded">Refresh Stats</button>
    </div>

    <!-- Users & Sessions Tab -->
    <div id="users" class="tab-content bg-white p-6 rounded shadow mb-4">
      <h2 class="text-2xl font-bold mb-4">Users & Active Sessions</h2>
      
      <div class="mb-4">
        <h3 class="font-semibold mb-2">Registered Users</h3>
        <div class="flex gap-2 mb-2">
          <input type="text" id="userSearch" placeholder="Search by email or name..." class="flex-1 border rounded p-2">
          <button onclick="searchUsers()" class="bg-blue-600 text-white px-4 py-2 rounded">Search</button>
          <button onclick="loadAllUsers()" class="bg-gray-600 text-white px-4 py-2 rounded">Load All</button>
        </div>
        <div id="usersList" class="text-sm text-gray-600">Click "Load All" to view users...</div>
      </div>

      <div class="mb-4 border-t pt-4">
        <h3 class="font-semibold mb-2">Active Sessions</h3>
        <div id="sessionsList" class="text-sm text-gray-600">Loading sessions...</div>
        <button onclick="loadActiveSessions()" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded">Refresh Sessions</button>
      </div>
    </div>

    <!-- Premium Access Tab -->
    <div id="premium" class="tab-content bg-white p-6 rounded shadow mb-4">
      <h2 class="text-2xl font-bold mb-4">Grant Premium Access</h2>
      
      <div class="mb-4 border p-4 rounded bg-blue-50">
        <h3 class="font-semibold mb-2">Grant Premium to User</h3>
        <div class="grid grid-cols-2 gap-2">
          <input type="email" id="premiumEmail" placeholder="User email" class="border rounded p-2">
          <input type="number" id="premiumDays" placeholder="Days of access" class="border rounded p-2" value="30">
          <input type="text" id="premiumReason" placeholder="Reason (optional)" class="col-span-2 border rounded p-2">
          <button onclick="grantPremiumAccess()" class="col-span-2 bg-green-600 text-white px-4 py-2 rounded">Grant Premium</button>
        </div>
        <div id="premiumStatus" class="text-sm mt-2"></div>
      </div>

      <div class="border p-4 rounded">
        <h3 class="font-semibold mb-2">Revoke Premium Access</h3>
        <div class="flex gap-2">
          <input type="email" id="revokeEmail" placeholder="User email" class="flex-1 border rounded p-2">
          <button onclick="revokePremiumAccess()" class="bg-red-600 text-white px-4 py-2 rounded">Revoke</button>
        </div>
        <div id="revokeStatus" class="text-sm mt-2"></div>
      </div>
    </div>

    <!-- File Manager Tab -->
    <div id="files" class="tab-content bg-white p-6 rounded shadow mb-4">
      <h2 class="text-2xl font-bold mb-4">File Manager</h2>
      
      <div class="mb-4 border p-4 rounded bg-gray-50">
        <h3 class="font-semibold mb-2">Upload File</h3>
        <form onsubmit="uploadFile(event)" class="space-y-2">
          <input type="text" id="fileTitle" placeholder="File title" class="w-full border rounded p-2" required>
          <input type="number" id="filePrice" placeholder="Price (USD)" class="w-full border rounded p-2" step="0.01" value="0">
          <textarea id="fileDescription" placeholder="Description (optional)" class="w-full border rounded p-2 h-20"></textarea>
          <input type="file" id="fileInput" class="w-full border rounded p-2" required>
          <button type="submit" class="w-full bg-blue-600 text-white px-4 py-2 rounded">Upload</button>
        </form>
        <div id="uploadStatus" class="text-sm mt-2"></div>
      </div>

      <div class="border p-4 rounded">
        <h3 class="font-semibold mb-2">Files Library</h3>
        <div class="flex gap-2 mb-2">
          <button onclick="loadFiles()" class="bg-blue-600 text-white px-4 py-2 rounded">Load Files</button>
          <button onclick="exportFilesList()" class="bg-green-600 text-white px-4 py-2 rounded">Export List</button>
        </div>
        <div id="filesList" class="text-sm text-gray-600 max-h-96 overflow-y-auto">Click "Load Files" to view...</div>
      </div>
    </div>

    <!-- Support Messages Tab -->
    <div id="messages" class="tab-content bg-white p-6 rounded shadow mb-4">
      <h2 class="text-2xl font-bold mb-4">Support Messages & Chat</h2>
      
      <div class="flex gap-2 mb-4">
        <button onclick="loadMessages()" class="bg-blue-600 text-white px-4 py-2 rounded">Load Messages</button>
        <button onclick="refreshMessages()" class="bg-gray-600 text-white px-4 py-2 rounded">Refresh</button>
      </div>

      <div id="messagesList" class="space-y-3 max-h-96 overflow-y-auto">
        <div class="text-gray-600 text-sm">Click "Load Messages" to view support tickets...</div>
      </div>
    </div>

    <!-- Payments Tab -->
    <div id="payments" class="tab-content bg-white p-6 rounded shadow mb-4">
      <h2 class="text-2xl font-bold mb-4">Payment Management</h2>
      
      <div class="mb-4">
        <h3 class="font-semibold mb-2">KCB Manual Transfers</h3>
        <div id="kcbTransfersList" class="text-sm text-gray-600 max-h-96 overflow-y-auto">Loading transfers...</div>
        <button onclick="loadKCBTransfers()" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded">Load Transfers</button>
        <button onclick="exportKCBCSV()" class="mt-2 bg-green-600 text-white px-4 py-2 rounded">Export CSV</button>
      </div>

      <div class="border-t pt-4">
        <h3 class="font-semibold mb-2">Reconcile Bank Entries</h3>
        <textarea id="reconcileData" placeholder="Paste JSON array of bank entries..." class="w-full border rounded p-2 h-24"></textarea>
        <div class="flex gap-2 mt-2">
          <button onclick="reconcileBankEntries()" class="bg-green-600 text-white px-4 py-2 rounded">Reconcile</button>
          <button onclick="document.getElementById('reconcileData').value=''" class="bg-gray-400 text-white px-4 py-2 rounded">Clear</button>
        </div>
        <div id="reconcileResult" class="text-sm mt-2 text-gray-600"></div>
      </div>

      <div class="border-t pt-4 mt-4">
        <h3 class="font-semibold mb-2">Request Payment Review</h3>
        <p class="text-sm text-gray-600 mb-2">For payments where automatic acceptance failed</p>
        <div class="flex gap-2">
          <input type="text" id="paymentId" placeholder="Payment ID or Transaction ID" class="flex-1 border rounded p-2">
          <button onclick="requestPaymentReview()" class="bg-orange-600 text-white px-4 py-2 rounded">Request Review</button>
        </div>
        <div id="reviewStatus" class="text-sm mt-2"></div>
      </div>

      <div class="border-t pt-4 mt-4">
        <div class="flex items-center justify-between mb-2">
          <div>
            <h3 class="font-semibold">All Payment Ledger</h3>
            <p class="text-sm text-gray-600">Mpesa, PayPal, and manual KCB with user details</p>
          </div>
          <button onclick="loadPaymentsLedger()" class="bg-blue-600 text-white px-3 py-2 rounded">Load Payments</button>
        </div>
        <div id="paymentsLedger" class="text-sm text-gray-700 max-h-96 overflow-y-auto border rounded p-3 bg-gray-50">Click "Load Payments" to view the latest ledger.</div>
      </div>
    </div>

    <!-- Email Tools Tab -->
    <div id="email" class="tab-content bg-white p-6 rounded shadow mb-4">
      <h2 class="text-2xl font-bold mb-4">Email Tools</h2>
      
      <div class="mb-4 border p-4 rounded bg-blue-50">
        <h3 class="font-semibold mb-2">Send Email to User</h3>
        <div class="space-y-2">
          <input type="email" id="emailTo" placeholder="Recipient email" class="w-full border rounded p-2" required>
          <input type="text" id="emailSubject" placeholder="Subject" class="w-full border rounded p-2" required>
          <textarea id="emailBody" placeholder="Email body (HTML or plain text)" class="w-full border rounded p-2 h-32" required></textarea>
          <button onclick="sendEmail()" class="w-full bg-blue-600 text-white px-4 py-2 rounded">Send Email</button>
        </div>
        <div id="emailStatus" class="text-sm mt-2"></div>
      </div>

      <div class="border p-4 rounded">
        <h3 class="font-semibold mb-2">Send Bulk Email</h3>
        <div class="space-y-2">
          <input type="text" id="bulkSubject" placeholder="Subject" class="w-full border rounded p-2" required>
          <textarea id="bulkBody" placeholder="Email body" class="w-full border rounded p-2 h-24" required></textarea>
          <select id="bulkRecipients" class="w-full border rounded p-2">
            <option value="">-- Select Recipients --</option>
            <option value="all-users">All Users</option>
            <option value="premium-users">Premium Users Only</option>
            <option value="free-users">Free Users Only</option>
            <option value="inactive">Inactive Users (7+ days)</option>
          </select>
          <button onclick="sendBulkEmail()" class="w-full bg-green-600 text-white px-4 py-2 rounded">Send Bulk Email</button>
        </div>
        <div id="bulkStatus" class="text-sm mt-2"></div>
      </div>
    </div>
  </div>

  <script>
    function switchTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
      
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');
      
      if (tabName === 'dashboard') refreshDashboard();
      if (tabName === 'users') loadAllUsers();
      if (tabName === 'messages') loadMessages();
      if (tabName === 'payments') loadKCBTransfers();
    }

    async function refreshDashboard() {
      try {
        const res = await fetch('/api/admin/dashboard-stats');
        if (res.ok) {
          const data = await res.json();
          document.getElementById('stat-users').textContent = data.totalUsers || '0';
          document.getElementById('stat-premium').textContent = data.premiumUsers || '0';
          document.getElementById('stat-files').textContent = data.filesCount || '0';
          document.getElementById('stat-messages').textContent = data.pendingMessages || '0';
        }
      } catch (e) {
        console.error('Dashboard error:', e);
      }
    }

    // === USERS & SESSIONS ===
    async function loadAllUsers() {
      try {
        const res = await fetch('/api/admin/users');
        const data = await res.json();
        const list = document.getElementById('usersList');
        
        if (!data.success || !data.users.length) {
          list.innerHTML = '<div class="text-gray-600">No users found.</div>';
          return;
        }

        const rows = data.users.map(u => `
          <div class="border rounded p-2 mb-2">
            <div class="flex justify-between items-start">
              <div>
                <strong>${u.name || 'N/A'}</strong><br>
                <small class="text-gray-600">${u.email}</small><br>
                <small class="text-xs text-gray-500">Registered: ${u.createdAt || 'N/A'}</small>
              </div>
              <div class="text-right">
                <span class="text-xs bg-${u.isPremium ? 'green' : 'gray'}-100 px-2 py-1 rounded">${u.isPremium ? 'Premium' : 'Free'}</span>
              </div>
            </div>
          </div>
        `).join('');

        list.innerHTML = rows;
      } catch (e) {
        document.getElementById('usersList').innerHTML = '<div class="text-red-600">Error loading users</div>';
      }
    }

    async function searchUsers() {
      const email = document.getElementById('userSearch').value;
      if (!email) return alert('Enter email to search');
      
      try {
        const res = await fetch(`/api/admin/users?search=${encodeURIComponent(email)}`);
        const data = await res.json();
        const list = document.getElementById('usersList');
        
        if (!data.users.length) {
          list.innerHTML = '<div class="text-gray-600">No users found.</div>';
          return;
        }

        const rows = data.users.map(u => `
          <div class="border rounded p-2 mb-2">
            <strong>${u.name || 'N/A'}</strong> - ${u.email}
            <div class="text-xs text-gray-600 mt-1">Status: ${u.isPremium ? 'Premium' : 'Free'}</div>
          </div>
        `).join('');

        list.innerHTML = rows;
      } catch (e) {
        alert('Search error: ' + e.message);
      }
    }

    async function loadActiveSessions() {
      try {
        const res = await fetch('/api/admin/sessions');
        const data = await res.json();
        const list = document.getElementById('sessionsList');
        
        if (!data.success || !data.sessions.length) {
          list.innerHTML = '<div class="text-gray-600">No active sessions.</div>';
          return;
        }

        const rows = data.sessions.map(s => `
          <div class="border rounded p-2 mb-2 text-sm">
            <strong>${s.userEmail}</strong><br>
            <small class="text-gray-600">IP: ${s.ip || 'N/A'} | Last: ${s.lastActivity || 'N/A'}</small>
          </div>
        `).join('');

        list.innerHTML = rows;
      } catch (e) {
        document.getElementById('sessionsList').innerHTML = '<div class="text-red-600">Error loading sessions</div>';
      }
    }

    // === PREMIUM ACCESS ===
    async function grantPremiumAccess() {
      const email = document.getElementById('premiumEmail').value;
      const days = parseInt(document.getElementById('premiumDays').value) || 30;
      const reason = document.getElementById('premiumReason').value;

      if (!email) return alert('Enter email');

      try {
        const res = await fetch('/api/admin/grant-premium', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, days, reason })
        });

        const data = await res.json();
        const status = document.getElementById('premiumStatus');

        if (data.success) {
          status.textContent = `✓ Premium granted to ${email} for ${days} days`;
          status.className = 'text-sm text-green-600 mt-2';
          document.getElementById('premiumEmail').value = '';
          document.getElementById('premiumDays').value = '30';
          document.getElementById('premiumReason').value = '';
        } else {
          status.textContent = '✗ Error: ' + (data.error || 'Failed');
          status.className = 'text-sm text-red-600 mt-2';
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    async function revokePremiumAccess() {
      const email = document.getElementById('revokeEmail').value;
      if (!email) return alert('Enter email');

      if (!confirm('Revoke premium for ' + email + '?')) return;

      try {
        const res = await fetch('/api/admin/revoke-premium', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });

        const data = await res.json();
        const status = document.getElementById('revokeStatus');

        if (data.success) {
          status.textContent = `✓ Premium revoked for ${email}`;
          status.className = 'text-sm text-green-600 mt-2';
          document.getElementById('revokeEmail').value = '';
        } else {
          status.textContent = '✗ Error: ' + (data.error || 'Failed');
          status.className = 'text-sm text-red-600 mt-2';
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    // === FILE MANAGER ===
    async function uploadFile(e) {
      e.preventDefault();

      const title = document.getElementById('fileTitle').value;
      const price = document.getElementById('filePrice').value;
      const description = document.getElementById('fileDescription').value;
      const fileInput = document.getElementById('fileInput');

      if (!fileInput.files.length) return alert('Select a file');

      const fd = new FormData();
      fd.append('file', fileInput.files[0]);
      fd.append('title', title);
      fd.append('price', price);
      fd.append('description', description);

      try {
        const res = await fetch('/api/admin/files/upload', {
          method: 'POST',
          body: fd
        });

        const data = await res.json();
        const status = document.getElementById('uploadStatus');

        if (data.success) {
          status.textContent = '✓ File uploaded successfully';
          status.className = 'text-sm text-green-600';
          document.getElementById('fileTitle').value = '';
          document.getElementById('filePrice').value = '0';
          document.getElementById('fileDescription').value = '';
          fileInput.value = '';
          setTimeout(loadFiles, 1000);
        } else {
          status.textContent = '✗ Upload failed: ' + (data.error || '');
          status.className = 'text-sm text-red-600';
        }
      } catch (e) {
        document.getElementById('uploadStatus').textContent = '✗ Error: ' + e.message;
        document.getElementById('uploadStatus').className = 'text-sm text-red-600';
      }
    }

    async function loadFiles() {
      try {
        const res = await fetch('/api/admin/files');
        const data = await res.json();
        const list = document.getElementById('filesList');

        if (!data.success || !data.files.length) {
          list.innerHTML = '<div class="text-gray-600">No files uploaded.</div>';
          return;
        }

        const rows = data.files.map(f => `
          <div class="border rounded p-2 mb-2">
            <div class="flex justify-between items-start">
              <div>
                <strong>${f.title}</strong><br>
                <small class="text-gray-600">Price: $${f.price}</small><br>
                <small class="text-xs text-gray-500">${f.originalName}</small>
              </div>
              <div class="space-x-1">
                <button onclick="togglePublish('${f.id}',${f.published})" class="bg-gray-500 text-white px-2 py-1 rounded text-xs">${f.published ? 'Unpublish' : 'Publish'}</button>
                <button onclick="deleteFile('${f.id}')" class="bg-red-600 text-white px-2 py-1 rounded text-xs">Delete</button>
              </div>
            </div>
          </div>
        `).join('');

        list.innerHTML = rows;
      } catch (e) {
        document.getElementById('filesList').innerHTML = '<div class="text-red-600">Error loading files</div>';
      }
    }

    async function togglePublish(id, current) {
      try {
        const res = await fetch(`/api/admin/files/${id}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ published: !current })
        });

        const data = await res.json();
        if (data.success) loadFiles();
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    async function deleteFile(id) {
      if (!confirm('Delete this file?')) return;

      try {
        const res = await fetch(`/api/admin/files/${id}`, { method: 'DELETE' });
        const data = await res.json();

        if (data.success) {
          alert('File deleted');
          loadFiles();
        } else {
          alert('Error: ' + (data.error || 'Failed'));
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    function exportFilesList() {
      alert('Export functionality to be implemented');
    }

    // === MESSAGES ===
    async function loadMessages() {
      try {
        const res = await fetch('/api/admin/messages');
        const data = await res.json();
        const list = document.getElementById('messagesList');

        if (!data.success || !data.messages.length) {
          list.innerHTML = '<div class="text-gray-600">No messages.</div>';
          return;
        }

        const rows = data.messages.map(m => `
          <div class="border rounded p-3 bg-gray-50">
            <div class="flex justify-between">
              <div>
                <strong>${m.name}</strong><br>
                <small class="text-gray-600">${m.email}</small>
              </div>
              <small class="text-gray-500">${m.createdAt}</small>
            </div>
            <div class="mt-2 text-sm">${m.message}</div>
            ${(m.replies || []).map(r => `
              <div class="mt-2 p-2 bg-white border-l-4 border-blue-600">
                <strong class="text-blue-600">Admin Reply:</strong><br>
                <small class="text-gray-500">${r.at}</small>
                <div class="text-sm mt-1">${r.message}</div>
              </div>
            `).join('')}
            <div class="mt-2 flex gap-2">
              <input id="reply_${m.id}" type="text" placeholder="Your reply..." class="flex-1 border rounded p-2 text-sm">
              <button onclick="replyMessage('${m.id}')" class="bg-blue-600 text-white px-3 py-1 rounded text-sm">Reply</button>
            </div>
          </div>
        `).join('');

        list.innerHTML = rows;
      } catch (e) {
        document.getElementById('messagesList').innerHTML = '<div class="text-red-600">Error loading messages</div>';
      }
    }

    async function replyMessage(id) {
      const input = document.getElementById(`reply_${id}`);
      const text = input.value.trim();

      if (!text) return alert('Enter a reply');

      try {
        const res = await fetch(`/api/admin/messages/${id}/reply`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reply: text })
        });

        const data = await res.json();
        if (data.success) {
          input.value = '';
          loadMessages();
        } else {
          alert('Error: ' + (data.error || 'Failed'));
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    function refreshMessages() {
      loadMessages();
    }

    // === PAYMENTS ===
    async function loadKCBTransfers() {
      try {
        const res = await fetch('/api/admin/kcb-transfers');
        const data = await res.json();
        const list = document.getElementById('kcbTransfersList');

        if (!data.success || !data.transfers.length) {
          list.innerHTML = '<div class="text-gray-600">No transfers found.</div>';
          return;
        }

        const rows = data.transfers.map(t => `
          <div class="border rounded p-2 mb-2 text-sm">
            <div class="flex justify-between">
              <div>
                <strong>${t.name}</strong> (${t.email})<br>
                <small class="text-gray-600">KES ${t.amount} - Ref: ${t.reference || 'N/A'}</small>
              </div>
              <div class="text-right">
                <span class="text-xs bg-${t.status === 'paid' ? 'green' : 'yellow'}-100 px-2 py-1 rounded">${t.status}</span><br>
                <small class="text-gray-500">${t.timestamp}</small>
              </div>
            </div>
            ${t.status !== 'paid' ? `<button onclick="markPaid('${t.timestamp}')" class="mt-1 bg-green-600 text-white px-2 py-1 rounded text-xs">Mark Paid</button>` : ''}
          </div>
        `).join('');

        list.innerHTML = rows;
      } catch (e) {
        document.getElementById('kcbTransfersList').innerHTML = '<div class="text-red-600">Error loading transfers</div>';
      }
    }

    async function markPaid(ts) {
      const note = prompt('Optional note for this transfer:');
      
      try {
        const res = await fetch('/api/admin/kcb/mark-paid', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ timestamp: ts, note })
        });

        const data = await res.json();
        if (data.success) {
          alert('Transfer marked as paid');
          loadKCBTransfers();
        } else {
          alert('Error: ' + (data.error || 'Failed'));
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    async function exportKCBCSV() {
      try {
        const res = await fetch('/api/admin/kcb-export');
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'kcb-transfers.csv';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (e) {
        alert('Export failed: ' + e.message);
      }
    }

    async function reconcileBankEntries() {
      const txt = document.getElementById('reconcileData').value.trim();
      if (!txt) return alert('Paste JSON array');

      let arr;
      try {
        arr = JSON.parse(txt);
      } catch (e) {
        return alert('Invalid JSON: ' + e.message);
      }

      try {
        const res = await fetch('/api/admin/kcb/reconcile', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ entries: arr })
        });

        const data = await res.json();
        const result = document.getElementById('reconcileResult');

        if (data.success) {
          result.textContent = `✓ Matched: ${data.summary.matched}, Unmatched: ${data.summary.unmatched}`;
          result.className = 'text-sm text-green-600 mt-2';
          loadKCBTransfers();
        } else {
          result.textContent = '✗ Error: ' + (data.error || '');
          result.className = 'text-sm text-red-600 mt-2';
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    async function requestPaymentReview() {
      const paymentId = document.getElementById('paymentId').value.trim();
      if (!paymentId) return alert('Enter payment ID');

      try {
        const res = await fetch('/api/admin/payment-review', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ paymentId })
        });

        const data = await res.json();
        const status = document.getElementById('reviewStatus');

        if (data.success) {
          status.textContent = `✓ Review requested for payment ${paymentId}`;
          status.className = 'text-sm text-green-600';
          document.getElementById('paymentId').value = '';
        } else {
          status.textContent = '✗ Error: ' + (data.error || 'Failed');
          status.className = 'text-sm text-red-600';
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    async function loadPaymentsLedger() {
      try {
        const res = await fetch('/api/admin/payments');
        const data = await res.json();
        const list = document.getElementById('paymentsLedger');

        if (!data.success) {
          list.innerHTML = '<div class="text-red-600">Error loading payments ledger.</div>';
          return;
        }

        if (!data.payments.length) {
          list.innerHTML = '<div class="text-gray-600">No payments recorded yet.</div>';
          return;
        }

        const rows = data.payments.map(p => `
          <div class="bg-white border rounded p-3 mb-2">
            <div class="flex justify-between items-start">
              <div>
                <div class="text-xs uppercase tracking-wide text-gray-500">${p.provider}</div>
                <div class="font-semibold">${p.amount ? p.amount : 'N/A'} ${p.currency || ''}</div>
                <div class="text-xs text-gray-600">${p.fileTitle ? 'File: ' + p.fileTitle : ''}</div>
              </div>
              <div class="text-right">
                <span class="text-xs px-2 py-1 rounded bg-${p.status === 'success' || p.status === 'paid' ? 'green' : p.status === 'pending' ? 'yellow' : 'red'}-100">${p.status}</span><br>
                <small class="text-gray-500">${p.createdAt || ''}</small>
              </div>
            </div>
            <div class="text-xs text-gray-700 mt-2">User: ${p.email || 'N/A'} ${p.phone ? '(' + p.phone + ')' : ''}</div>
            <div class="text-xs text-gray-600">Reference: ${p.reference || 'N/A'} ${p.receipt ? ' • Receipt: ' + p.receipt : ''}</div>
            ${p.note ? `<div class="text-xs text-gray-600">Note: ${p.note}</div>` : ''}
          </div>
        `).join('');

        list.innerHTML = rows;
      } catch (e) {
        document.getElementById('paymentsLedger').innerHTML = '<div class="text-red-600">Error loading payments</div>';
      }
    }

    // === EMAIL TOOLS ===
    async function sendEmail() {
      const to = document.getElementById('emailTo').value;
      const subject = document.getElementById('emailSubject').value;
      const body = document.getElementById('emailBody').value;

      if (!to || !subject || !body) return alert('Fill all fields');

      try {
        const res = await fetch('/api/admin/send-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ to, subject, body })
        });

        const data = await res.json();
        const status = document.getElementById('emailStatus');

        if (data.success) {
          status.textContent = '✓ Email sent to ' + to;
          status.className = 'text-sm text-green-600';
          document.getElementById('emailTo').value = '';
          document.getElementById('emailSubject').value = '';
          document.getElementById('emailBody').value = '';
        } else {
          status.textContent = '✗ Error: ' + (data.error || 'Failed');
          status.className = 'text-sm text-red-600';
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    async function sendBulkEmail() {
      const subject = document.getElementById('bulkSubject').value;
      const body = document.getElementById('bulkBody').value;
      const recipients = document.getElementById('bulkRecipients').value;

      if (!subject || !body || !recipients) return alert('Fill all fields');

      try {
        const res = await fetch('/api/admin/send-bulk-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ subject, body, recipients })
        });

        const data = await res.json();
        const status = document.getElementById('bulkStatus');

        if (data.success) {
          status.textContent = `✓ Email sent to ${data.sentCount} recipients`;
          status.className = 'text-sm text-green-600';
          document.getElementById('bulkSubject').value = '';
          document.getElementById('bulkBody').value = '';
          document.getElementById('bulkRecipients').value = '';
        } else {
          status.textContent = '✗ Error: ' + (data.error || 'Failed');
          status.className = 'text-sm text-red-600';
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    // Initial load
    window.addEventListener('load', () => {
      refreshDashboard();
    });
  </script>
</body>
</html>
