<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>SmartInvest Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="/wwwroot/css/animations.css" rel="stylesheet">
  <style>
    .dashboard-card {
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .dashboard-card:hover {
      transform: translateY(-5px) scale(1.02);
      box-shadow: 0 12px 24px rgba(0,0,0,0.15);
    }
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 12px;
      padding: 1.5rem;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .stat-card::before {
      content: '';
      position: absolute;
      inset-block-start: -50%;
      inset-inline-end: -50%;
      inline-size: 200%;
      block-size: 200%;
      background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
      transform: rotate(45deg);
      transition: all 0.5s ease;
    }
    .stat-card:hover::before {
      animation: shimmer 1.5s infinite;
    }
    @keyframes shimmer {
      0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
      100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
    }
    .stat-card:hover {
      transform: scale(1.05);
    }
    .nav-tab {
      padding: 0.75rem 1.5rem;
      cursor: pointer;
      border-block-end: 3px solid transparent;
      transition: all 0.3s ease;
      position: relative;
    }
    .nav-tab::before {
      content: '';
      position: absolute;
      inset-block-end: 0;
      inset-inline-start: 0;
      inline-size: 0;
      block-size: 3px;
      background: linear-gradient(90deg, #7C3AED, #EC4899);
      transition: width 0.3s ease;
    }
    .nav-tab:hover {
      background: linear-gradient(to bottom, #F3F4F6, transparent);
    }
    .nav-tab:hover::before {
      inline-size: 100%;
    }
    .nav-tab.active {
      color: #7C3AED;
      font-weight: 600;
    }
    .nav-tab.active::before {
      inline-size: 100%;
    }
    .tab-content {
      display: none;
      animation: fadeInUp 0.5s ease;
    }
    .tab-content.active {
      display: block;
    }
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .action-button {
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      position: relative;
      overflow: hidden;
    }
    .action-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
    }
    .action-button:active {
      transform: translateY(0);
    }
    .refresh-button {
      transition: all 0.3s ease;
    }
    .refresh-button:hover {
      transform: rotate(180deg);
    }
    .loading {
      animation: pulse 1.5s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
  </style>
</head>
<body class="bg-gray-50">
  <!-- Header -->
  <header class="bg-white shadow-sm border-b sticky top-0 z-50 transition-all">
    <div class="max-w-7xl mx-auto px-4 py-4">
      <div class="flex justify-between items-center">
        <div class="animate-on-scroll slide-in-left">
          <h1 class="text-2xl font-bold gradient-text">üìä SmartInvest Admin</h1>
          <p class="text-sm text-gray-500">Dashboard & Management Console</p>
        </div>
        <div class="flex gap-3 animate-on-scroll slide-in-right">
          <a href="/" class="btn-enhanced bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg text-sm font-medium transition">
            üè† View Site
          </a>
          <button onclick="refreshAllData()" class="btn-enhanced bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2">
            <span class="refresh-button inline-block">üîÑ</span> Refresh All
          </button>
          <button onclick="adminLogout()" class="btn-enhanced bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2">
            üö™ Logout
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Navigation Tabs -->
  <div class="bg-white border-b sticky top-[89px] z-40">
    <div class="max-w-7xl mx-auto px-4">
      <nav class="flex gap-1 overflow-x-auto">
        <div class="nav-tab active" onclick="switchTab('overview')">
          <span class="text-xl">üìä</span> Overview
        </div>
        <div class="nav-tab" onclick="switchTab('users')">
          <span class="text-xl">üë•</span> Users
          <span class="notification-badge" id="usersBadge" style="display:none;">0</span>
        </div>
        <div class="nav-tab" onclick="switchTab('analytics')">
          <span class="text-xl">üìà</span> Analytics
        </div>
        <div class="nav-tab" onclick="switchTab('transactions')">
          <span class="text-xl">üí≥</span> Transactions
        </div>
        <div class="nav-tab" onclick="switchTab('messages')">
          <span class="text-xl">üí¨</span> Messages
          <span class="notification-badge" id="messagesBadge" style="display:none;">0</span>
        </div>
        <div class="nav-tab" onclick="switchTab('transfers')">
          <span class="text-xl">üí∞</span> Transfers
          <span class="notification-badge" id="transfersBadge" style="display:none;">0</span>
        </div>
        <div class="nav-tab" onclick="switchTab('access-reviews')">
          <span class="text-xl">üõ°Ô∏è</span> Access Reviews
          <span class="notification-badge" id="accessBadge" style="display:none;">0</span>
        </div>
        <div class="nav-tab" onclick="switchTab('files')">
          <span class="text-xl">üìÅ</span> Files
        </div>
        <div class="nav-tab" onclick="switchTab('products')">
          <span class="text-xl">üì¶</span> Products
        </div>
        <div class="nav-tab" onclick="switchTab('roles')">
          <span class="text-xl">üëë</span> Roles & Users
        </div>
        <div class="nav-tab" onclick="window.location.href='/admin-executive.html'">
          Executive Admin
        </div>
        <div class="nav-tab" onclick="window.location.href='/admin-product-files.html'">
          <span class="text-xl">üì§</span> File Manager
        </div>
        <div class="nav-tab" onclick="window.location.href='/admin-social-media.html'">
          <span class="text-xl">üåê</span> Social Media
        </div>
      </nav>
    </div>
  </div>

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto px-4 py-6">

    <!-- Consolidated Resources Notice -->
    <div style="margin-bottom: 24px; padding: 12px 16px; background: #f0f9ff; border-left: 4px solid #0ea5e9; border-radius: 8px; font-size: 0.9rem; color: #1e40af;">
      <strong>Shared Utilities:</strong> Common admin functions consolidated in <code style="background: #e0f2fe; padding: 2px 6px; border-radius: 4px;">/public/js/shared-admin-utils.js</code> - includes auth, roles, tabs, and API utilities used across all admin pages.
    </div>

    <!-- Overview Tab -->
    <div id="overview" class="tab-content active">
      <div class="grid md:grid-cols-4 gap-6 mb-6">
        <div class="stat-card animate-on-scroll slide-in-left">
          <div class="text-sm opacity-90">Total Users</div>
          <div class="text-3xl font-bold mt-2" id="statTotalUsers">0</div>
          <div class="text-xs opacity-75 mt-1">Registered accounts</div>
        </div>
        <div class="stat-card animate-on-scroll scale-in" style="animation-delay: 0.05s;">
          <div class="text-sm opacity-90">Premium Users</div>
          <div class="text-3xl font-bold mt-2" id="statPremiumUsers">0</div>
          <div class="text-xs opacity-75 mt-1">Active premium</div>
        </div>
        <div class="stat-card animate-on-scroll slide-in-left" style="animation-delay: 0.1s;">
          <div class="text-sm opacity-90">Total Messages</div>
          <div class="text-3xl font-bold mt-2" id="statMessages">0</div>
          <div class="text-xs opacity-75 mt-1">All time</div>
        </div>
        <div class="stat-card animate-on-scroll scale-in" style="animation-delay: 0.15s;">
          <div class="text-sm opacity-90">Pending Transfers</div>
          <div class="text-3xl font-bold mt-2" id="statTransfers">0</div>
          <div class="text-xs opacity-75 mt-1">Awaiting confirmation</div>
        </div>
      </div>

      <div class="grid md:grid-cols-3 gap-6 mb-6">
        <div class="stat-card animate-on-scroll slide-in-right" style="animation-delay: 0.2s; background: linear-gradient(135deg, #F093FB 0%, #F5576C 100%);">
          <div class="text-sm opacity-90">Total Files</div>
          <div class="text-3xl font-bold mt-2" id="statFiles">0</div>
          <div class="text-xs opacity-75 mt-1">In marketplace</div>
        </div>
        <div class="stat-card animate-on-scroll slide-in-right" style="animation-delay: 0.25s; background: linear-gradient(135deg, #4FACFE 0%, #00F2FE 100%);">
          <div class="text-sm opacity-90">Total Transactions</div>
          <div class="text-3xl font-bold mt-2" id="statTotalTransactions">0</div>
          <div class="text-xs opacity-75 mt-1">All payments</div>
        </div>
        <div class="stat-card animate-on-scroll slide-in-right" style="animation-delay: 0.3s; background: linear-gradient(135deg, #43E97B 0%, #38F9D7 100%);">
          <div class="text-sm opacity-90">Total Visitors</div>
          <div class="text-3xl font-bold mt-2" id="statVisitors">0</div>
          <div class="text-xs opacity-75 mt-1">Site visits</div>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow-lg p-6 dashboard-card animate-on-scroll">
        <h2 class="text-xl font-bold mb-4 gradient-text">‚ö° Quick Actions</h2>
        <div class="grid md:grid-cols-3 gap-4">
          <button onclick="switchTab('users')" class="action-button bg-purple-100 hover:bg-purple-200 p-4 rounded-lg text-left transition">
            <div class="font-semibold text-purple-700 flex items-center gap-2">
              <span class="text-2xl">üë•</span> Manage Users
            </div>
            <div class="text-sm text-gray-600 mt-1">Grant/revoke access</div>
          </button>
          <button onclick="switchTab('analytics')" class="action-button bg-blue-100 hover:bg-blue-200 p-4 rounded-lg text-left transition">
            <div class="font-semibold text-blue-700 flex items-center gap-2">
              <span class="text-2xl">üìà</span> View Analytics
            </div>
            <div class="text-sm text-gray-600 mt-1">Traffic & engagement</div>
          </button>
          <button onclick="switchTab('transactions')" class="action-button bg-green-100 hover:bg-green-200 p-4 rounded-lg text-left transition">
            <div class="font-semibold text-green-700 flex items-center gap-2">
              <span class="text-2xl">üí≥</span> View Transactions
            </div>
            <div class="text-sm text-gray-600 mt-1">Payment history</div>
          </button>
          <button onclick="switchTab('messages')" class="bg-indigo-100 hover:bg-indigo-200 p-4 rounded-lg text-left transition">
            <div class="font-semibold text-indigo-700">üí¨ Review Messages</div>
            <div class="text-sm text-gray-600 mt-1">Respond to visitors</div>
          </button>
          <button onclick="switchTab('transfers')" class="bg-orange-100 hover:bg-orange-200 p-4 rounded-lg text-left transition">
            <div class="font-semibold text-orange-700">üí∞ Review Transfers</div>
            <div class="text-sm text-gray-600 mt-1">Mark payments received</div>
          </button>
          <button onclick="switchTab('files')" class="bg-pink-100 hover:bg-pink-200 p-4 rounded-lg text-left transition">
            <div class="font-semibold text-pink-700">üìÅ Manage Files</div>
            <div class="text-sm text-gray-600 mt-1">Upload resources</div>
          </button>
          <button onclick="exportAllData()" class="bg-yellow-100 hover:bg-yellow-200 p-4 rounded-lg text-left transition">
            <div class="font-semibold text-yellow-700">üìä Export All Data</div>
            <div class="text-sm text-gray-600 mt-1">Download reports</div>
          </button>
          <button onclick="exportUsers()" class="bg-teal-100 hover:bg-teal-200 p-4 rounded-lg text-left transition">
            <div class="font-semibold text-teal-700">üë• Export Users</div>
            <div class="text-sm text-gray-600 mt-1">User CSV export</div>
          </button>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow-lg p-6 dashboard-card animate-on-scroll mt-6">
        <h2 class="text-xl font-bold mb-2 gradient-text">Consolidated Admin Features</h2>
        <p class="text-sm text-gray-600 mb-4">Single reference list for all admin features to avoid repetition.</p>
        <div class="grid md:grid-cols-3 gap-3 text-sm">
          <a href="#overview" class="bg-gray-100 hover:bg-gray-200 px-4 py-3 rounded-lg font-medium transition">Overview</a>
          <a href="#users" class="bg-gray-100 hover:bg-gray-200 px-4 py-3 rounded-lg font-medium transition">Users</a>
          <a href="#analytics" class="bg-gray-100 hover:bg-gray-200 px-4 py-3 rounded-lg font-medium transition">Analytics</a>
          <a href="#transactions" class="bg-gray-100 hover:bg-gray-200 px-4 py-3 rounded-lg font-medium transition">Transactions</a>
          <a href="#messages" class="bg-gray-100 hover:bg-gray-200 px-4 py-3 rounded-lg font-medium transition">Messages</a>
          <a href="#transfers" class="bg-gray-100 hover:bg-gray-200 px-4 py-3 rounded-lg font-medium transition">Transfers</a>
          <a href="#access-reviews" class="bg-gray-100 hover:bg-gray-200 px-4 py-3 rounded-lg font-medium transition">Access Reviews</a>
          <a href="#files" class="bg-gray-100 hover:bg-gray-200 px-4 py-3 rounded-lg font-medium transition">Files</a>
          <a href="#products" class="bg-gray-100 hover:bg-gray-200 px-4 py-3 rounded-lg font-medium transition">Products</a>
          <a href="#roles" class="bg-gray-100 hover:bg-gray-200 px-4 py-3 rounded-lg font-medium transition">Roles & Users</a>
          <a href="/admin-product-files.html" class="bg-gray-100 hover:bg-gray-200 px-4 py-3 rounded-lg font-medium transition">File Manager</a>
          <a href="/admin-social-media.html" class="bg-gray-100 hover:bg-gray-200 px-4 py-3 rounded-lg font-medium transition">Social Media</a>
          <a href="/admin-executive.html" class="bg-gray-100 hover:bg-gray-200 px-4 py-3 rounded-lg font-medium transition">Executive Admin</a>
        </div>
      </div>
    </div>

    <!-- Users Tab -->
    <div id="users" class="tab-content">
      <div class="max-w-6xl mx-auto bg-white p-6 rounded shadow">
        <h2 class="text-2xl font-bold mb-4 text-purple-600">Registered Users</h2>
        <div class="flex gap-2 mb-4">
          <button onclick="loadUsers()" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg font-medium transition">üîÑ Reload</button>
          <button onclick="exportUsers()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition">üì• Export CSV</button>
        </div>
        <div id="usersList">Loading users‚Ä¶</div>
      </div>
    </div>

    <!-- Analytics Tab -->
    <div id="analytics" class="tab-content">
      <div class="max-w-6xl mx-auto bg-white p-6 rounded shadow">
        <h2 class="text-2xl font-bold mb-4 text-purple-600">Platform Analytics</h2>
        <div class="flex gap-2 mb-4">
          <button onclick="loadAnalytics()" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg font-medium transition">üîÑ Reload</button>
        </div>
        <div id="analyticsContent">Loading analytics‚Ä¶</div>
      </div>
    </div>

    <!-- Transactions Tab -->
    <div id="transactions" class="tab-content">
      <div class="max-w-6xl mx-auto bg-white p-6 rounded shadow">
        <h2 class="text-2xl font-bold mb-4 text-purple-600">All Transactions</h2>
        <div class="flex gap-2 mb-4">
          <button onclick="loadTransactions()" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg font-medium transition">üîÑ Reload</button>
        </div>
        <div id="transactionsList">Loading transactions‚Ä¶</div>
      </div>
    </div>

    <!-- Messages Tab -->
    <div id="messages" class="tab-content">
      <div class="max-w-6xl mx-auto bg-white p-6 rounded shadow">
        <h2 class="text-2xl font-bold mb-4 text-purple-600">Site Messages</h2>
        <div class="mb-3 text-sm text-gray-600">Visitors can post messages; only admins may reply.</div>
        <div id="adminMessages">Loading messages‚Ä¶</div>
      </div>
    </div>

    <!-- Transfers Tab -->
    <div id="transfers" class="tab-content">
  <!-- KCB Transfers Section -->
      <div class="max-w-6xl mx-auto bg-white p-6 rounded shadow">
        <h2 class="text-2xl font-bold mb-4 text-purple-600">Pending KCB Manual Transfers</h2>
        <div class="flex gap-2 mb-4">
          <button id="exportBtn" onclick="exportCsv()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition">üì• Export CSV</button>
          <button id="reloadBtn" onclick="load()" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg font-medium transition">üîÑ Reload</button>
        </div>
        <div id="list">Loading‚Ä¶</div>
        <div class="mt-6">
          <h3 class="font-semibold mb-2">Reconcile bank entries (paste JSON array)</h3>
          <textarea id="reconcileData" rows="6" class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-purple-500 focus:border-transparent"></textarea>
          <div class="flex gap-2 mt-2">
            <button onclick="reconcile()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition">‚úÖ Reconcile</button>
            <button onclick="document.getElementById('reconcileData').value='';" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg font-medium transition">Clear</button>
          </div>
          <div id="reconcileResult" class="mt-3 text-sm text-gray-700"></div>
        </div>
      </div>
    </div>

    <!-- Access Reviews Tab -->
    <div id="access-reviews" class="tab-content">
      <div class="max-w-6xl mx-auto bg-white p-6 rounded shadow">
        <h2 class="text-2xl font-bold mb-4 text-purple-600">Access Reviews</h2>
        <div class="flex gap-2 mb-4">
          <button onclick="loadAccessViolations()" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg font-medium transition">üîÑ Reload</button>
        </div>
        <div id="accessReviewList">Loading access reviews‚Ä¶</div>
      </div>
    </div>

    <!-- Roles & Users Tab -->
    <div id="roles" class="tab-content">
      <div class="max-w-6xl mx-auto bg-white p-6 rounded shadow">
        <h2 class="text-2xl font-bold mb-4 text-purple-600">Roles & User Management</h2>
        <p class="text-sm text-gray-600 mb-6">Manage admin roles, executives, CEOs, board members, investors, and prominent persons.</p>
        
        <!-- Add User to Role -->
        <div class="bg-gray-50 p-4 rounded-lg border-2 border-dashed border-gray-300 mb-6">
          <h3 class="font-semibold mb-3">Add User to Role</h3>
          <form id="addRoleForm" onsubmit="event.preventDefault(); addUserToRole();">
            <div class="grid md:grid-cols-2 gap-3 mb-3">
              <div>
                <label class="block text-sm font-semibold mb-1">Email Address</label>
                <input id="roleEmail" type="email" class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-purple-500" placeholder="user@example.com" required/>
              </div>
              <div>
                <label class="block text-sm font-semibold mb-1">Full Name</label>
                <input id="roleName" type="text" class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-purple-500" placeholder="John Doe" required/>
              </div>
            </div>
            <div class="grid md:grid-cols-2 gap-3 mb-3">
              <div>
                <label class="block text-sm font-semibold mb-1">Role</label>
                <select id="roleSelect" class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-purple-500" required>
                  <option value="admin">Admin</option>
                  <option value="ceos-admin">CEO Admin (Super Admin)</option>
                  <option value="executive">Executive</option>
                  <option value="bom">Board Member (BOM)</option>
                  <option value="investor">Investor</option>
                  <option value="prominent">Prominent Person</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-semibold mb-1">Department/Organization</label>
                <input id="roleDept" type="text" class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-purple-500" placeholder="e.g., Finance, Operations"/>
              </div>
            </div>
            <div class="mb-3">
              <label class="flex items-center text-sm">
                <input type="checkbox" id="roleActive" checked class="mr-2 w-4 h-4"/>
                <span class="font-medium">Active immediately</span>
              </label>
            </div>
            <div class="flex gap-2">
              <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg font-medium transition">Add User to Role</button>
              <button type="reset" class="bg-gray-200 hover:bg-gray-300 px-6 py-2 rounded-lg font-medium transition">Clear</button>
            </div>
            <div id="roleAddStatus" class="text-sm mt-3"></div>
          </form>
        </div>

        <!-- Current Roles & Users -->
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <h3 class="font-semibold mb-3 text-lg">CEO Admin (Super Admin)</h3>
            <div id="roleCeosAdmin" class="space-y-2 bg-gradient-to-br from-red-50 to-red-100 p-4 rounded-lg border border-red-200"></div>
          </div>
          <div>
            <h3 class="font-semibold mb-3 text-lg">Admins</h3>
            <div id="roleAdmin" class="space-y-2 bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg border border-purple-200 min-h-20"></div>
          </div>
          <div>
            <h3 class="font-semibold mb-3 text-lg">Executives</h3>
            <div id="roleExecutive" class="space-y-2 bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200 min-h-20"></div>
          </div>
          <div>
            <h3 class="font-semibold mb-3 text-lg">Board Members (BOM)</h3>
            <div id="roleBom" class="space-y-2 bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg border border-green-200 min-h-20"></div>
          </div>
          <div>
            <h3 class="font-semibold mb-3 text-lg">Investors</h3>
            <div id="roleInvestor" class="space-y-2 bg-gradient-to-br from-yellow-50 to-yellow-100 p-4 rounded-lg border border-yellow-200 min-h-20"></div>
          </div>
          <div>
            <h3 class="font-semibold mb-3 text-lg">Prominent Persons</h3>
            <div id="roleProminent" class="space-y-2 bg-gradient-to-br from-orange-50 to-orange-100 p-4 rounded-lg border border-orange-200 min-h-20"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Files Tab -->
    <div id="files" class="tab-content">
  <!-- File Marketplace Section -->
      <div class="max-w-6xl mx-auto bg-white p-6 rounded shadow">
        <h2 class="text-2xl font-bold mb-4 text-purple-600">File Marketplace (Admin)</h2>
        <form id="uploadForm" class="mb-6 bg-gray-50 p-4 rounded-lg border-2 border-dashed border-gray-300" onsubmit="event.preventDefault(); uploadFileMarketplace();">
          <div class="mb-3"><label class="block text-sm font-semibold mb-1">Title</label><input id="fileTitle" name="title" class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-purple-500" placeholder="Enter file title"/></div>
          <div class="mb-3"><label class="block text-sm font-semibold mb-1">Price (USD)</label><input id="filePrice" name="price" type="number" step="0.01" class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-purple-500" placeholder="0.00"/></div>
          <div class="mb-3"><label class="block text-sm font-semibold mb-1">Description</label><textarea id="fileDescription" name="description" rows="3" class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-purple-500" placeholder="Describe the file..."></textarea></div>
          <div class="mb-3"><label class="block text-sm font-semibold mb-1">File (PDF or any)</label><input type="file" id="fileInput" name="file" class="w-full border rounded-lg p-2 bg-white"/></div>
          <div class="mb-3"><label class="flex items-center text-sm"><input type="checkbox" id="filePublished" name="published" class="mr-2 w-4 h-4"/> <span class="font-medium">Publish immediately</span></label></div>
          <div class="flex gap-2">
            <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg font-medium transition">üì§ Upload File</button>
            <button type="button" onclick="loadFiles()" class="bg-gray-200 hover:bg-gray-300 px-6 py-2 rounded-lg font-medium transition">üîÑ Refresh</button>
          </div>
          <div id="uploadStatus" class="text-sm mt-3"></div>
        </form>
        <div id="filesList">Loading files‚Ä¶</div>
      </div>
    </div>

  </div>

<script>
// ==========================================
// AUTHENTICATION CHECK
// ==========================================
(function() {
  // Check if user has valid admin token
  const adminToken = localStorage.getItem('adminToken') || sessionStorage.getItem('adminToken');
  
  if (!adminToken) {
    // No token found, redirect to admin login
    window.location.href = 'admin-login.html';
    return;
  }

  // Verify token with backend
  fetch('/api/auth/verify-admin', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${adminToken}`
    },
    body: JSON.stringify({ token: adminToken })
  })
  .then(res => res.json())
  .then(data => {
    if (!data.success) {
      // Token is invalid or expired
      alert('Your session has expired. Please login again.');
      localStorage.removeItem('adminToken');
      sessionStorage.removeItem('adminToken');
      window.location.href = 'admin-login.html';
    } else {
      // Token is valid, display admin info
      console.log('Admin authenticated:', data.user);
      displayAdminInfo(data.user);
    }
  })
  .catch(err => {
    console.error('Auth verification error:', err);
    alert('Authentication error. Please login again.');
    window.location.href = 'admin-login.html';
  });
})();

// Display admin info in dashboard
function displayAdminInfo(user) {
  // You can add admin info display here if needed
  console.log('Logged in as:', user.email, '- Role:', user.role);
}

// Logout function
function adminLogout() {
  const adminToken = localStorage.getItem('adminToken') || sessionStorage.getItem('adminToken');
  
  if (adminToken) {
    fetch('/api/auth/admin-logout', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ token: adminToken })
    })
    .then(() => {
      localStorage.removeItem('adminToken');
      localStorage.removeItem('adminEmail');
      sessionStorage.removeItem('adminToken');
      sessionStorage.removeItem('adminEmail');
      window.location.href = 'admin-login.html';
    })
    .catch(err => {
      console.error('Logout error:', err);
      // Still clear local storage and redirect
      localStorage.clear();
      sessionStorage.clear();
      window.location.href = 'admin-login.html';
    });
  } else {
    window.location.href = 'admin-login.html';
  }
}

// ==========================================
// TAB SWITCHING & NAVIGATION
// ==========================================
// Tab Switching
function switchTab(tabName, clickedElement) {
  // Hide all tabs
  const tabs = document.querySelectorAll('.tab-content');
  tabs.forEach(tab => tab.classList.remove('active'));
  
  // Remove active from all nav items
  const navTabs = document.querySelectorAll('.nav-tab');
  navTabs.forEach(nav => nav.classList.remove('active'));
  
  // Show selected tab
  const selectedTab = document.getElementById(tabName);
  if (selectedTab) {
    selectedTab.classList.add('active');
    if (window.location.hash !== `#${tabName}`) {
      history.replaceState(null, '', `#${tabName}`);
    }
  }
  
  // Add active to clicked nav (if element passed) or find by tabName
  if (clickedElement) {
    clickedElement.classList.add('active');
  } else {
    const clickedTab = Array.from(navTabs).find(tab => {
      const tabText = tab.textContent.toLowerCase();
      return tabText.includes(tabName.toLowerCase()) || tab.getAttribute('onclick')?.includes(`'${tabName}'`);
    });
    if (clickedTab) clickedTab.classList.add('active');
  }
}

function activateTabFromHash() {
  const tabName = window.location.hash.replace('#', '');
  if (tabName) {
    switchTab(tabName);
  }
}

window.addEventListener('hashchange', activateTabFromHash);
window.addEventListener('load', activateTabFromHash);

// Refresh All Data
async function refreshAllData() {
  await Promise.all([loadFiles(), load(), loadAdminMessages(), loadUsers(), loadAnalytics(), loadTransactions(), loadAccessViolations(), updateStats()]);
  alert('‚úÖ All data refreshed!');
}

// Update Dashboard Stats
async function updateStats() {
  try {
    const res = await fetch('/api/admin/stats');
    const data = await res.json();
    
    if (data.success) {
      const stats = data.stats;
      document.getElementById('statTotalUsers').textContent = stats.totalUsers || 0;
      document.getElementById('statPremiumUsers').textContent = stats.premiumUsers || 0;
      document.getElementById('statMessages').textContent = stats.totalMessages || 0;
      document.getElementById('statTransfers').textContent = stats.pendingTransactions || 0;
      document.getElementById('statFiles').textContent = stats.totalFiles || 0;
      document.getElementById('statTotalTransactions').textContent = stats.totalTransactions || 0;
      document.getElementById('statVisitors').textContent = stats.totalVisitors || 0;
    }
  } catch (e) {
    console.error('Failed to update stats', e);
  }
}

// Analytics Functions
async function loadAnalytics() {
  try {
    const res = await fetch('/api/admin/analytics');
    const data = await res.json();
    const out = document.getElementById('analyticsContent');
    
    if (!data.success) {
      out.textContent = 'Failed to load analytics';
      return;
    }
    
    const analytics = data.analytics;
    const visitors = analytics.visitors || [];
    const signups = analytics.signups || [];
    const logins = analytics.logins || [];
    
    out.innerHTML = `
      <div class="grid md:grid-cols-3 gap-6 mb-6">
        <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6 rounded-lg shadow">
          <div class="text-sm opacity-90">Total Visitors</div>
          <div class="text-4xl font-bold mt-2">${visitors.length}</div>
        </div>
        <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-lg shadow">
          <div class="text-sm opacity-90">Total Signups</div>
          <div class="text-4xl font-bold mt-2">${signups.length}</div>
        </div>
        <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-6 rounded-lg shadow">
          <div class="text-sm opacity-90">Total Logins</div>
          <div class="text-4xl font-bold mt-2">${logins.length}</div>
        </div>
      </div>
      
      <div class="mb-6">
        <h3 class="text-lg font-semibold mb-3">Recent Visitors (Last 10)</h3>
        <div class="overflow-x-auto">
          <table class="w-full text-sm border">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-3 py-2 text-left">Timestamp</th>
                <th class="px-3 py-2 text-left">Source</th>
                <th class="px-3 py-2 text-left">Referrer</th>
                <th class="px-3 py-2 text-left">User Agent</th>
              </tr>
            </thead>
            <tbody>
              ${visitors.slice(-10).reverse().map(v => `
                <tr class="border-b">
                  <td class="px-3 py-2">${new Date(v.timestamp).toLocaleString()}</td>
                  <td class="px-3 py-2">${v.source || 'N/A'}</td>
                  <td class="px-3 py-2">${v.referrer || 'Direct'}</td>
                  <td class="px-3 py-2 text-xs">${v.userAgent ? v.userAgent.substring(0, 50) + '...' : 'N/A'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      </div>
      
      <div>
        <h3 class="text-lg font-semibold mb-3">Recent Signups (Last 10)</h3>
        <div class="overflow-x-auto">
          <table class="w-full text-sm border">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-3 py-2 text-left">Email</th>
                <th class="px-3 py-2 text-left">Timestamp</th>
              </tr>
            </thead>
            <tbody>
              ${signups.slice(-10).reverse().map(s => `
                <tr class="border-b">
                  <td class="px-3 py-2">${s.email}</td>
                  <td class="px-3 py-2">${new Date(s.timestamp).toLocaleString()}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      </div>
    `;
  } catch (e) {
    console.error('loadAnalytics error', e);
    document.getElementById('analyticsContent').textContent = 'Error loading analytics';
  }
}

// Transactions Functions
async function loadTransactions() {
  try {
    const res = await fetch('/api/admin/transactions');
    const data = await res.json();
    const out = document.getElementById('transactionsList');
    
    if (!data.success) {
      out.textContent = 'Failed to load transactions';
      return;
    }
    
    const transactions = data.transactions || [];
    
    if (transactions.length === 0) {
      out.innerHTML = '<div class="text-gray-600">No transactions found.</div>';
      return;
    }
    
    const rows = transactions.map(t => {
      const statusBadge = t.status === 'paid' || t.status === 'completed' 
        ? '<span class="bg-green-500 text-white px-2 py-1 rounded text-xs">Completed</span>'
        : '<span class="bg-yellow-500 text-white px-2 py-1 rounded text-xs">Pending</span>';
      
      return `<tr class="border-b hover:bg-gray-50">
        <td class="px-3 py-3 text-xs">${t.timestamp || 'N/A'}</td>
        <td class="px-3 py-3">
          <div class="font-medium">${t.provider || 'N/A'}</div>
          <div class="text-xs text-gray-500">${t.reference || ''}</div>
        </td>
        <td class="px-3 py-3">
          <div>${t.email || 'N/A'}</div>
          <div class="text-xs text-gray-500">${t.name || ''}</div>
        </td>
        <td class="px-3 py-3 font-semibold">${t.amount || 0}</td>
        <td class="px-3 py-3">${statusBadge}</td>
        <td class="px-3 py-3 text-xs">${t.paidAt ? new Date(t.paidAt).toLocaleString() : 'Not paid'}</td>
      </tr>`;
    }).join('');
    
    out.innerHTML = `<div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead class="bg-gray-100">
          <tr class="text-left">
            <th class="px-3 py-3">Timestamp</th>
            <th class="px-3 py-3">Provider/Reference</th>
            <th class="px-3 py-3">User</th>
            <th class="px-3 py-3">Amount</th>
            <th class="px-3 py-3">Status</th>
            <th class="px-3 py-3">Paid At</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;
  } catch (e) {
    console.error('loadTransactions error', e);
    document.getElementById('transactionsList').textContent = 'Error loading transactions';
  }
}

// Export Functions
async function exportUsers() {
  try {
    const res = await fetch('/api/admin/users-export');
    if (!res.ok) throw new Error('Export failed');
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `users-export-${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    alert('‚úÖ Users exported successfully!');
  } catch (e) {
    alert('‚ùå Failed to export users: ' + e.message);
  }
}

async function exportAllData() {
  if (!confirm('Export all platform data? This will download multiple files.')) return;
  
  try {
    await exportUsers();
    await downloadReport();
    alert('‚úÖ All data exported!');
  } catch (e) {
    alert('‚ùå Failed to export all data');
  }
}

// Download Report
async function downloadReport() {
  try {
    const response = await fetch('/api/admin/kcb-export');
    const blob = await response.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `transfers-report-${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    alert('‚úÖ Report downloaded!');
  } catch (e) {
    alert('‚ùå Failed to download report');
  }
}

// File marketplace upload
async function uploadFileMarketplace(){
  const inp = document.getElementById('fileInput');
  if (!inp.files.length) return alert('Pick a file');
  const fd = new FormData(); 
  fd.append('file', inp.files[0]);
  fd.append('title', document.getElementById('fileTitle').value);
  fd.append('price', document.getElementById('filePrice').value || 0);
  fd.append('description', document.getElementById('fileDescription').value || '');
  fd.append('published', document.getElementById('filePublished').checked ? 'true' : 'false');
  document.getElementById('uploadStatus').textContent = 'Uploading‚Ä¶';
  const res = await fetch('/api/admin/files/upload', { method: 'POST', body: fd });
  const data = await res.json();
  if (data.success) { 
    document.getElementById('uploadStatus').textContent = 'Uploaded successfully!'; 
    document.getElementById('uploadForm').reset();
    loadFiles(); 
  } else { 
    document.getElementById('uploadStatus').textContent = 'Upload failed: '+(data.error||''); 
  }
}

async function loadFiles(){
  const res = await fetch('/api/admin/files');
  const d = await res.json();
  const out = document.getElementById('filesList');
  if (!d.success) return out.textContent = 'Failed to load files';
  if (!d.files.length) return out.innerHTML = '<div class="text-gray-600">No files uploaded.</div>';
  const rows = d.files.map(f=>`<tr class="border-b text-sm"><td class="px-2 py-2">${f.title}<br/><small>${f.originalName}</small></td><td class="px-2 py-2">$${f.price}</td><td class="px-2 py-2">${f.published?'<span class="text-green-600">Published</span>':'<span class="text-yellow-600">Draft</span>'}</td><td class="px-2 py-2"><button onclick="togglePublish('${f.id}',${f.published})" class="bg-gray-200 px-2 py-1 rounded">Toggle</button> <button onclick="grant('${f.id}')" class="bg-blue-600 text-white px-2 py-1 rounded">Grant</button> <button onclick="createToken('${f.id}')" class="bg-indigo-600 text-white px-2 py-1 rounded">Create token</button></td></tr>`).join('');
  out.innerHTML = `<table class="w-full"><thead><tr class="text-left text-gray-600"><th class="px-2 py-2">Title</th><th class="px-2 py-2">Price</th><th class="px-2 py-2">Status</th><th class="px-2 py-2">Action</th></tr></thead><tbody>${rows}</tbody></table>`;
}

async function togglePublish(id,current){
  const res = await fetch('/api/admin/files/'+id,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ published: !current })});
  const d = await res.json(); if (d.success) loadFiles(); else alert('Failed');
}

async function grant(id){
  const email = prompt('Email to grant access to'); if (!email) return;
  const res = await fetch('/api/admin/files/'+id+'/grant',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ email })});
  const d = await res.json(); if (d.success) alert('Granted'); else alert('Failed: '+(d.error||''));
}

async function createToken(id){
  const email = prompt('Email to create a download token for'); if (!email) return;
  // first ensure purchase exists (admin might have granted already). Try request token directly.
  const res = await fetch('/api/download/request',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ fileId: id, email })});
  const d = await res.json(); if (d.success) { prompt('Download URL (copy):', d.url); } else { alert('Failed: '+(d.error||'')); }
}

loadFiles();
async function load() {
  const res = await fetch('/api/admin/kcb-transfers');
  const data = await res.json();
  const list = document.getElementById('list');
  if (!data.success) { list.textContent = 'Failed to load'; return; }
  if (!data.transfers.length) { list.innerHTML = '<div class="text-gray-600">No transfers found.</div>'; return; }
  const rows = data.transfers.map(t=>`<tr class="border-b"><td class="px-2 py-2">${t.timestamp}</td><td class="px-2 py-2">${t.name}<br/><small>${t.email}</small></td><td class="px-2 py-2">KES ${t.amount}</td><td class="px-2 py-2">${t.reference || ''}</td><td class="px-2 py-2">${t.status}</td><td class="px-2 py-2"><button onclick="markPaid('${t.timestamp}')" class="bg-green-600 text-white px-3 py-1 rounded">Mark paid</button></td></tr>`).join('');
  list.innerHTML = `<table class="w-full text-sm"> <thead><tr class="text-left text-gray-600"><th class="px-2 py-2">Time</th><th class="px-2 py-2">Name/Email</th><th class="px-2 py-2">Amount</th><th class="px-2 py-2">Reference</th><th class="px-2 py-2">Status</th><th class="px-2 py-2">Action</th></tr></thead><tbody>${rows}</tbody></table>`;
}

async function markPaid(ts){
  if (!confirm('Mark this transfer as paid?')) return;
  const note = prompt('Optional note for this transfer');
  const res = await fetch('/api/admin/kcb/mark-paid',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ timestamp: ts, note })});
  const data = await res.json();
  if (data.success) { alert('Marked paid'); load(); } else { alert('Failed: '+(data.error||'')); }
}

async function exportCsv(){
  const res = await fetch('/api/admin/kcb-export');
  if (!res.ok) return alert('Export failed');
  const blob = await res.blob();
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'kcb-transfers.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

async function reconcile(){
  const txt = document.getElementById('reconcileData').value;
  if (!txt) return alert('Paste JSON array of bank entries first');
  let arr;
  try { arr = JSON.parse(txt); } catch(e){ return alert('Invalid JSON'); }
  const res = await fetch('/api/admin/kcb/reconcile',{method:'POST',headers:{'Content-Type':'application/json'},body: JSON.stringify({ entries: arr })});
  const data = await res.json();
  if (data.success) {
    document.getElementById('reconcileResult').textContent = `Matched: ${data.summary.matched}, Unmatched: ${data.summary.unmatched}`;
    load();
  } else {
    document.getElementById('reconcileResult').textContent = 'Reconcile failed: '+(data.error||'');
  }
}

// Messages admin helpers
async function loadAdminMessages(){
  try {
    const res = await fetch('/api/admin/messages');
    const d = await res.json();
    const out = document.getElementById('adminMessages');
    if (!d.success) return out.textContent = 'Failed to load messages';
    if (!d.messages.length) return out.innerHTML = '<div class="text-gray-600">No messages.</div>';
    const rows = d.messages.map(m=>{
      const replies = (m.replies||[]).map(r=>`<div class="mt-2 p-2 bg-gray-50 border rounded"><strong>${r.by}</strong> <small class="text-xs text-gray-500">${r.at}</small><div>${r.message}</div></div>`).join('');
      return `<div class="border-b py-2">
        <div class="flex justify-between"><div><strong>${m.name}</strong> <small class="text-xs text-gray-500">${m.createdAt}</small></div><div class="text-sm">${m.email||''}</div></div>
        <div class="mt-1">${m.message}</div>
        ${replies}
        <div class="mt-2 flex gap-2"><input id="reply_input_${m.id}" placeholder="Reply as admin" class="flex-1 border rounded p-1"/><button onclick="replyMessage('${m.id}')" class="bg-blue-600 text-white px-2 py-1 rounded">Reply</button></div>
      </div>`;
    }).join('');
    out.innerHTML = rows;
  } catch (e) { console.error('loadAdminMessages error', e); document.getElementById('adminMessages').textContent = 'Error loading messages'; }
}

async function replyMessage(id){
  const el = document.getElementById('reply_input_'+id);
  if (!el) return alert('Input not found');
  const txt = el.value || '';
  if (!txt.trim()) return alert('Enter reply');
  const res = await fetch('/api/admin/messages/'+id+'/reply',{ method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ reply: txt }) });
  const d = await res.json();
  if (d.success) { alert('Replied'); el.value = ''; loadAdminMessages(); } else { alert('Failed: '+(d.error||'')); }
}

// Scroll Animation Observer
function initScrollAnimations() {
  const elements = document.querySelectorAll('.animate-on-scroll');
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.classList.add('visible');
      }
    });
  }, { threshold: 0.1 });

  elements.forEach(el => observer.observe(el));
}

// Users Management Functions
async function loadUsers() {
  try {
    const res = await fetch('/api/admin/users');
    const d = await res.json();
    const out = document.getElementById('usersList');
    if (!d.success) return out.textContent = 'Failed to load users';
    if (!d.users.length) return out.innerHTML = '<div class="text-gray-600">No registered users.</div>';
    
    const rows = d.users.map(u => {
      const premiumBadge = u.isPremium ? '<span class="bg-green-500 text-white px-2 py-1 rounded text-xs">Premium</span>' : '<span class="bg-gray-400 text-white px-2 py-1 rounded text-xs">Free</span>';
      const adminBadge = u.isAdmin ? '<span class="bg-purple-500 text-white px-2 py-1 rounded text-xs ml-1">Admin</span>' : '';
      
      return `<tr class="border-b hover:bg-gray-50">
        <td class="px-3 py-3">
          <div class="font-medium">${u.email}</div>
          <div class="text-xs text-gray-500">ID: ${u.id}</div>
          <div class="text-xs text-gray-500">Created: ${new Date(u.createdAt).toLocaleString()}</div>
        </td>
        <td class="px-3 py-3">
          <div>${u.mobileNumber || 'N/A'}</div>
        </td>
        <td class="px-3 py-3">
          <div>${u.paymentMethod || 'N/A'}</div>
          <div class="text-xs text-gray-500">Amount: ${u.amount || 0}</div>
        </td>
        <td class="px-3 py-3">
          ${premiumBadge}${adminBadge}
        </td>
        <td class="px-3 py-3">
          ${u.lastLoginAt ? new Date(u.lastLoginAt).toLocaleDateString() : 'Never'}
        </td>
        <td class="px-3 py-3">
          <div class="flex flex-col gap-1">
            ${!u.isPremium ? `<button onclick="grantPremium('${u.id}')" class="bg-green-600 text-white px-2 py-1 rounded text-xs hover:bg-green-700">Grant Premium</button>` : `<button onclick="revokePremium('${u.id}')" class="bg-orange-600 text-white px-2 py-1 rounded text-xs hover:bg-orange-700">Revoke Premium</button>`}
            ${!u.isAdmin ? `<button onclick="makeAdmin('${u.id}')" class="bg-purple-600 text-white px-2 py-1 rounded text-xs hover:bg-purple-700">Make Admin</button>` : `<button onclick="removeAdmin('${u.id}')" class="bg-red-600 text-white px-2 py-1 rounded text-xs hover:bg-red-700">Remove Admin</button>`}
            <button onclick="viewUserDetails('${u.id}')" class="bg-blue-600 text-white px-2 py-1 rounded text-xs hover:bg-blue-700">View Details</button>
          </div>
        </td>
      </tr>`;
    }).join('');
    
    out.innerHTML = `<div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead class="bg-gray-100">
          <tr class="text-left text-gray-700">
            <th class="px-3 py-3 font-semibold">User Info</th>
            <th class="px-3 py-3 font-semibold">Mobile</th>
            <th class="px-3 py-3 font-semibold">Payment Info</th>
            <th class="px-3 py-3 font-semibold">Status</th>
            <th class="px-3 py-3 font-semibold">Last Login</th>
            <th class="px-3 py-3 font-semibold">Actions</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;
    
    // Update stats
    document.getElementById('statUsers')?.setAttribute('data-count', d.users.length);
  } catch (e) {
    console.error('loadUsers error', e);
    document.getElementById('usersList').textContent = 'Error loading users';
  }
}

async function grantPremium(userId) {
  if (!confirm('Grant premium access to this user?')) return;
  
  try {
    const res = await fetch(`/api/admin/users/${userId}/grant-premium`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ requirements: { verified: true } })
    });
    const d = await res.json();
    
    if (d.success) {
      alert('‚úÖ Premium access granted successfully!');
      loadUsers();
    } else {
      alert('Failed to grant premium: ' + (d.error || ''));
    }
  } catch (e) {
    alert('Error: ' + e.message);
  }
}

async function revokePremium(userId) {
  if (!confirm('Revoke premium access from this user?')) return;
  
  try {
    const res = await fetch(`/api/admin/users/${userId}/revoke-premium`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    const d = await res.json();
    
    if (d.success) {
      alert('‚úÖ Premium access revoked successfully!');
      loadUsers();
    } else {
      alert('Failed to revoke premium: ' + (d.error || ''));
    }
  } catch (e) {
    alert('Error: ' + e.message);
  }
}

async function makeAdmin(userId) {
  if (!confirm('Grant admin access to this user? This gives them full control of the platform.')) return;
  
  try {
    const res = await fetch('/api/admin/add-admin', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId, requirements: { verified: true, adminApproved: true } })
    });
    const d = await res.json();
    
    if (d.success) {
      alert('‚úÖ Admin access granted successfully!');
      loadUsers();
    } else {
      alert('Failed to grant admin access: ' + (d.error || ''));
    }
  } catch (e) {
    alert('Error: ' + e.message);
  }
}

async function removeAdmin(userId) {
  if (!confirm('Remove admin access from this user?')) return;
  
  try {
    const res = await fetch('/api/admin/remove-admin', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId })
    });
    const d = await res.json();
    
    if (d.success) {
      alert('‚úÖ Admin access removed successfully!');
      loadUsers();
    } else {
      alert('Failed to remove admin access: ' + (d.error || ''));
    }
  } catch (e) {
    alert('Error: ' + e.message);
  }
}

function viewUserDetails(userId) {
  // Fetch and display detailed user information
  fetch(`/api/admin/users`)
    .then(r => r.json())
    .then(d => {
      if (d.success) {
        const user = d.users.find(u => u.id === userId);
        if (user) {
          const taxInfo = user.taxInfo && typeof user.taxInfo === 'object' ? JSON.stringify(user.taxInfo, null, 2) : 'N/A';
          alert(`User Details:\n\nID: ${user.id}\nEmail: ${user.email}\nMobile: ${user.mobileNumber || 'N/A'}\nPayment Method: ${user.paymentMethod || 'N/A'}\nAmount: ${user.amount || 0}\nTax Info: ${taxInfo}\nPremium: ${user.isPremium ? 'Yes' : 'No'}\nAdmin: ${user.isAdmin ? 'Yes' : 'No'}\nCreated: ${new Date(user.createdAt).toLocaleString()}\nLast Login: ${user.lastLoginAt ? new Date(user.lastLoginAt).toLocaleString() : 'Never'}`);
        }
      }
    })
    .catch(e => alert('Error loading user details'));
}

// ==========================================
// ACCESS REVIEWS
// ==========================================
async function loadAccessViolations() {
  try {
    const res = await fetch('/api/admin/access-violations');
    const data = await res.json();
    const out = document.getElementById('accessReviewList');
    if (!data.success) {
      out.textContent = 'Failed to load access reviews';
      return;
    }

    const violations = data.violations || [];
    const pending = violations.filter(v => v.status === 'pending');
    const badge = document.getElementById('accessBadge');
    if (badge) {
      badge.style.display = pending.length ? 'inline-block' : 'none';
      badge.textContent = pending.length;
    }

    if (!violations.length) {
      out.innerHTML = '<div class="text-sm text-gray-500">No access violations recorded.</div>';
      return;
    }

    const rows = violations.map(v => {
      const status = v.status || 'pending';
      const statusColor = status === 'blocked' ? 'text-red-600' : status === 'authorized' ? 'text-green-600' : status === 'dismissed' ? 'text-gray-500' : 'text-yellow-600';
      return `
        <tr class="border-b">
          <td class="px-3 py-2">
            <div class="font-semibold">${v.reason || 'access_denied'}</div>
            <div class="text-xs text-gray-500">${new Date(v.at).toLocaleString()}</div>
            <div class="text-xs text-gray-500">${v.path || ''}</div>
          </td>
          <td class="px-3 py-2 text-sm">
            <div>${v.email || 'N/A'}</div>
            <div class="text-xs text-gray-500">File: ${v.fileId || 'N/A'}</div>
          </td>
          <td class="px-3 py-2 text-sm">
            <div>${v.ip || 'N/A'}</div>
            <div class="text-xs text-gray-500">${v.userAgent ? v.userAgent.slice(0, 40) + (v.userAgent.length > 40 ? '‚Ä¶' : '') : ''}</div>
          </td>
          <td class="px-3 py-2 text-sm font-semibold ${statusColor}">${status}</td>
          <td class="px-3 py-2">
            <div class="flex flex-col gap-1">
              <button onclick="takeAccessAction('${v.id}', 'block')" class="bg-red-600 text-white px-2 py-1 rounded text-xs hover:bg-red-700">Block IP</button>
              <button onclick="takeAccessAction('${v.id}', 'authorize')" class="bg-green-600 text-white px-2 py-1 rounded text-xs hover:bg-green-700">Authorize</button>
              <button onclick="takeAccessAction('${v.id}', 'dismiss')" class="bg-gray-600 text-white px-2 py-1 rounded text-xs hover:bg-gray-700">Dismiss</button>
            </div>
          </td>
        </tr>`;
    }).join('');

    out.innerHTML = `
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="bg-gray-100">
            <tr class="text-left text-gray-700">
              <th class="px-3 py-2 font-semibold">Event</th>
              <th class="px-3 py-2 font-semibold">User</th>
              <th class="px-3 py-2 font-semibold">Source</th>
              <th class="px-3 py-2 font-semibold">Status</th>
              <th class="px-3 py-2 font-semibold">Actions</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>`;
  } catch (e) {
    console.error('loadAccessViolations error', e);
    document.getElementById('accessReviewList').textContent = 'Error loading access reviews';
  }
}

async function takeAccessAction(id, action) {
  if (!confirm(`Apply action: ${action}?`)) return;
  const note = prompt('Optional note for this action:', '') || '';
  const payload = { action, note };
  if (action === 'block') payload.blockDuration = 24 * 60 * 60 * 1000;

  try {
    const res = await fetch(`/api/admin/access-violations/${id}/action`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (!data.success) {
      alert('Action failed: ' + (data.error || 'Unknown error'));
      return;
    }
    loadAccessViolations();
  } catch (e) {
    alert('Action error: ' + e.message);
  }
}

// ==========================================
// ROLES & USER MANAGEMENT
// ==========================================

const roleUsers = {
  'ceos-admin': [
    { email: 'delijah5415@gmail.com', name: 'CEO Admin', dept: 'Executive', active: true }
  ],
  'admin': [],
  'executive': [],
  'bom': [],
  'investor': [],
  'prominent': []
};

function loadRolesToUI() {
  Object.keys(roleUsers).forEach(role => {
    const elementId = role === 'ceos-admin' ? 'roleCeosAdmin' : 
                      role === 'bom' ? 'roleBom' :
                      role === 'investor' ? 'roleInvestor' :
                      role === 'prominent' ? 'roleProminent' :
                      `role${role.charAt(0).toUpperCase() + role.slice(1)}`;
    const container = document.getElementById(elementId);
    if (container) {
      const users = roleUsers[role];
      if (users.length === 0) {
        container.innerHTML = '<div class="text-sm text-gray-500 italic">No users assigned yet</div>';
      } else {
        container.innerHTML = users.map(u => `
          <div class="bg-white px-3 py-2 rounded flex justify-between items-center text-sm">
            <div>
              <div class="font-medium">${u.name}</div>
              <div class="text-xs text-gray-600">${u.email}</div>
              ${u.dept ? `<div class="text-xs text-gray-500">üìç ${u.dept}</div>` : ''}
            </div>
            <button onclick="removeUserFromRole('${role}', '${u.email}')" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs">Remove</button>
          </div>
        `).join('');
      }
    }
  });
}

function addUserToRole() {
  const email = document.getElementById('roleEmail').value.trim();
  const name = document.getElementById('roleName').value.trim();
  const role = document.getElementById('roleSelect').value;
  const dept = document.getElementById('roleDept').value.trim();
  const active = document.getElementById('roleActive').checked;
  const statusDiv = document.getElementById('roleAddStatus');

  if (!email || !name) {
    statusDiv.innerHTML = '<span class="text-red-600 font-medium">Error: Email and name are required</span>';
    return;
  }

  // Check for duplicates
  const isDuplicate = roleUsers[role].some(u => u.email.toLowerCase() === email.toLowerCase());
  if (isDuplicate) {
    statusDiv.innerHTML = '<span class="text-red-600 font-medium">Error: User already assigned to this role</span>';
    return;
  }

  // Add user
  roleUsers[role].push({ email, name, dept, active });

  // Save to localStorage for persistence
  localStorage.setItem('adminRoleUsers', JSON.stringify(roleUsers));

  statusDiv.innerHTML = '<span class="text-green-600 font-medium">‚úÖ User added successfully!</span>';
  
  // Reset form
  document.getElementById('addRoleForm').reset();
  
  // Refresh UI
  loadRolesToUI();

  // Clear status after 3 seconds
  setTimeout(() => { statusDiv.innerHTML = ''; }, 3000);
}

function removeUserFromRole(role, email) {
  if (!confirm(`Remove ${email} from ${role}?`)) return;
  
  roleUsers[role] = roleUsers[role].filter(u => u.email !== email);
  localStorage.setItem('adminRoleUsers', JSON.stringify(roleUsers));
  loadRolesToUI();
}

// Load saved roles on startup
const savedRoles = localStorage.getItem('adminRoleUsers');
if (savedRoles) {
  Object.assign(roleUsers, JSON.parse(savedRoles));
}

// Initialize on page load
window.addEventListener('load', () => {
  initScrollAnimations();
  loadRolesToUI();
});

load();
loadFiles();
loadAdminMessages();
loadUsers();
loadAnalytics();
loadTransactions();
loadAccessViolations();
updateStats();
</script>
</body>
</html>
