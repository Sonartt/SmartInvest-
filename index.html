<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
        <title>SmartInvest Africa</title>
        <meta name="description" content="SmartInvest Africa — democratizing investment knowledge, tools and opportunities across Africa. Learn, invest, and grow with confidence.">
        <meta name="robots" content="index,follow">
        <meta property="og:title" content="SmartInvest Africa">
        <meta property="og:description" content="Democratizing investment knowledge, tools and opportunity across Africa.">
        <meta property="og:type" content="website">
        <meta name="theme-color" content="#6D28D9">
        <link rel="canonical" href="https://yourdomain.example/">
        <meta name="twitter:card" content="summary_large_image">
        <meta name="twitter:site" content="@SmartInvestAF">
        <meta name="twitter:creator" content="@SmartInvestAF">
        <meta name="twitter:title" content="SmartInvest Africa">
        <meta name="twitter:description" content="Democratizing investment knowledge, tools and opportunity across Africa.">
        <meta name="twitter:image" content="https://yourdomain.example/social-share.png">
        <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%236D28D9'/%3E%3Ctext x='50' y='55' font-size='50' text-anchor='middle' fill='white' font-family='Arial'%3ESI%3C/text%3E%3C/svg%3E">
        <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
        <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "Organization",
            "name": "SmartInvest Africa",
            "url": "https://yourdomain.example/",
            "logo": "https://yourdomain.example/logo.png",
            "sameAs": []
        }
        </script>
        <style>
            /* Visible focus styles for keyboard users */
            :focus {
                outline: 3px solid #C4B5FD;
                outline-offset: 2px;
            }
            /* Ensure skip link is visible when focused */
            .sr-only-focusable:focus {
                position: static;
                width: auto;
                height: auto;
                margin: 0.5rem;
                padding: 0.5rem 1rem;
                background: white;
                color: #4C1D95;
                border-radius: 0.25rem;
            }
        </style>
</head>
<body class="antialiased">

    <a class="sr-only sr-only-focusable" href="#main-content">Skip to content</a>

        <!-- Hero Section -->
        <section id="hero" class="bg-gradient-to-br from-purple-600 to-purple-800 text-white py-20 px-4">
        <main id="main-content" class="max-w-7xl mx-auto text-center fade-in-up">
            <h1 class="text-5xl md:text-6xl font-bold mb-6">SmartInvest Africa</h1>
            <p class="text-xl md:text-2xl mb-8 text-purple-100">Democratizing investment knowledge, tools and opportunity across Africa. Learn, invest, and grow with confidence.</p>
            <div class="flex flex-col md:flex-row gap-4 justify-center mb-8">
                <button type="button" onclick="scrollToSection('academy')" class="bg-white text-purple-600 px-8 py-3 rounded-lg font-semibold hover:bg-purple-50 transition">Explore Courses</button>
                <button type="button" onclick="scrollToSection('insights')" class="border-2 border-white text-white px-8 py-3 rounded-lg font-semibold hover:bg-white hover:text-purple-600 transition">Read Insights</button>
            </div>
            
            <!-- Payment Section -->
            <div class="bg-white bg-opacity-10 backdrop-blur-md rounded-lg p-8 max-w-md mx-auto">
                <h3 class="text-2xl font-bold mb-4">Get Started Now</h3>
                <div class="space-y-3">
                    <button type="button" onclick="handleMpesaPay()" id="mpesaBtn" data-phone="254114383762" class="w-full bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-semibold transition">Pay with M-Pesa</button>
                    <button type="button" onclick="handlePayPalPay()" id="paypalBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold transition">Pay with PayPal</button>
                    <button type="button" onclick="toggleBankForm(true)" id="bankBtn" class="w-full bg-gray-800 hover:bg-gray-900 text-white px-6 py-3 rounded-lg font-semibold transition">Bank transfer (KCB)</button>
                </div>
                <div id="paymentMessage" class="mt-4 text-sm text-yellow-200"></div>
                <div id="bankForm" class="mt-4 p-4 bg-white bg-opacity-90 rounded shadow-sm" style="display:none;">
                    <h4 class="font-semibold mb-2 text-gray-800">Bank transfer — KCB</h4>
                    <form onsubmit="submitBankTransfer(event)" class="space-y-2">
                        <input id="bankName" type="text" placeholder="Full name" required class="w-full border border-gray-300 rounded px-3 py-2" />
                        <input id="bankEmail" type="email" placeholder="Email" required class="w-full border border-gray-300 rounded px-3 py-2" />
                        <input id="bankAmount" type="number" placeholder="Amount (KES)" required class="w-full border border-gray-300 rounded px-3 py-2" />
                        <input id="bankReference" type="text" placeholder="Reference (optional)" class="w-full border border-gray-300 rounded px-3 py-2" />
                        <div class="flex gap-2">
                            <button type="submit" class="flex-1 bg-purple-600 text-white px-4 py-2 rounded">Record & Show Account</button>
                            <button type="button" onclick="toggleBankForm(false)" class="flex-1 bg-gray-200 text-gray-800 px-4 py-2 rounded">Cancel</button>
                        </div>
                    </form>
                    <div id="bankInstructions" class="mt-3 text-sm text-gray-700"></div>
                </div>
            </div>
        </main>
    </section>

    <!-- Academy Section -->
    <!-- Files / Marketplace Section -->
    <section id="files" aria-label="Files" class="py-20 px-4 bg-white">
        <div class="max-w-7xl mx-auto">
            <h2 class="text-4xl font-bold mb-6 text-center gradient-text">Files & Resources</h2>
            <p class="text-center text-gray-600 mb-6">Browse available files and purchase to get access.</p>
            <div id="catalog" class="grid md:grid-cols-3 gap-6">
                <div class="col-span-3 text-center text-gray-500">Loading catalog…</div>
            </div>
        </div>
    </section>

    <section id="academy" aria-label="Academy" class="py-20 px-4 bg-white">
        <div class="max-w-7xl mx-auto">
            <h2 id="academy-heading" class="text-4xl font-bold mb-12 text-center gradient-text">Investment Academy</h2>
            <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="card-hover bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                    <h3 class="text-xl font-bold mb-3 text-purple-600">Investing 101</h3>
                    <p class="text-gray-600 mb-4">Foundations: assets, risk, diversification.</p>
                    <span class="inline-block bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-sm font-semibold">Beginner</span>
                </div>
                <div class="card-hover bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                    <h3 class="text-xl font-bold mb-3 text-purple-600">Trading Essentials</h3>
                    <p class="text-gray-600 mb-4">Practical trading, psychology, risk control.</p>
                    <span class="inline-block bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm font-semibold">Intermediate</span>
                </div>
                <div class="card-hover bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                    <h3 class="text-xl font-bold mb-3 text-purple-600">SME Funding Readiness</h3>
                    <p class="text-gray-600 mb-4">Pitching, valuation, investor expectations.</p>
                    <span class="inline-block bg-green-100 text-green-700 px-3 py-1 rounded-full text-sm font-semibold">SME</span>
                </div>
                <div class="card-hover bg-white border border-gray-200 rounded-lg p-6 shadow-sm">
                    <h3 class="text-xl font-bold mb-3 text-purple-600">Digital Assets & Crypto</h3>
                    <p class="text-gray-600 mb-4">Custody, security, strategy for Africa.</p>
                    <span class="inline-block bg-orange-100 text-orange-700 px-3 py-1 rounded-full text-sm font-semibold">Advanced</span>
                </div>
            </div>
        </div>
    </section>

    <!-- Insights Section -->
    <section id="insights" aria-label="Insights" class="py-20 px-4 bg-gray-100">
        <div class="max-w-7xl mx-auto">
            <h2 id="insights-heading" class="text-4xl font-bold mb-12 text-center gradient-text">Latest Insights</h2>
            <div class="grid md:grid-cols-3 gap-6">
                <div class="card-hover bg-white rounded-lg p-6 shadow-md">
                    <h3 class="text-xl font-bold mb-3 text-slate-900">African Fintech Growth 2025</h3>
                    <p class="text-gray-600 mb-4">Key markets, players, and opportunities.</p>
                    <button class="text-purple-600 font-semibold hover:text-purple-800 transition">Read More →</button>
                </div>
                <div class="card-hover bg-white rounded-lg p-6 shadow-md">
                    <h3 class="text-xl font-bold mb-3 text-slate-900">Agribusiness Investments</h3>
                    <p class="text-gray-600 mb-4">High-impact rural investment cases.</p>
                    <button class="text-purple-600 font-semibold hover:text-purple-800 transition">Read More →</button>
                </div>
                <div class="card-hover bg-white rounded-lg p-6 shadow-md">
                    <h3 class="text-xl font-bold mb-3 text-slate-900">Green Energy Projects</h3>
                    <p class="text-gray-600 mb-4">Infrastructure that attracts global capital.</p>
                    <button class="text-purple-600 font-semibold hover:text-purple-800 transition">Read More →</button>
                </div>
            </div>
        </div>
    </section>

    <!-- Tools Section -->
    <section id="tools" aria-label="Tools" class="py-20 px-4 bg-white">
        <div class="max-w-7xl mx-auto">
            <h2 id="tools-heading" class="text-4xl font-bold mb-12 text-center gradient-text">Investment Tools</h2>
            <div class="grid md:grid-cols-3 gap-6">
                <div class="card-hover bg-gradient-to-br from-purple-50 to-purple-100 border border-purple-200 rounded-lg p-6">
                    <h3 class="text-xl font-bold mb-3 text-purple-700">Portfolio Tracker</h3>
                    <p class="text-gray-700 mb-4">Monitor holdings & performance.</p>
                    <button type="button" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition">Launch Tool</button>
                </div>
                <div class="card-hover bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 rounded-lg p-6">
                    <h3 class="text-xl font-bold mb-3 text-blue-700">Risk Profiler</h3>
                    <p class="text-gray-700 mb-4">Understand your risk tolerance.</p>
                    <button type="button" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">Launch Tool</button>
                </div>
                <div class="card-hover bg-gradient-to-br from-green-50 to-green-100 border border-green-200 rounded-lg p-6">
                    <h3 class="text-xl font-bold mb-3 text-green-700">Savings Automator</h3>
                    <p class="text-gray-700 mb-4">Automate micro-savings into investments.</p>
                    <button type="button" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">Launch Tool</button>
                </div>
            </div>
        </div>
    </section>

    <!-- SME Section -->
    <section id="sme" aria-label="SME Funding" class="py-20 px-4 bg-gradient-to-r from-purple-600 to-purple-800 text-white">
        <div class="max-w-4xl mx-auto text-center">
            <h2 class="text-4xl font-bold mb-6">SME Funding Readiness</h2>
            <p class="text-lg mb-8 text-purple-100">Empowering Small and Medium Enterprises with pitching skills, valuation knowledge, and understanding investor expectations.</p>
            <button class="bg-white text-purple-600 px-8 py-3 rounded-lg font-semibold hover:bg-purple-50 transition">Get Started</button>
        </div>
    </section>

    <!-- Community Section -->
    <section id="community" aria-label="Community" class="py-20 px-4 bg-gray-100">
        <div class="max-w-4xl mx-auto text-center">
            <h2 class="text-4xl font-bold mb-6 gradient-text">Join Our Community</h2>
            <p class="text-lg text-gray-700 mb-8">Connect with fellow investors, share insights, and grow together in SmartInvest Africa's vibrant community.</p>
            <button class="bg-purple-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-purple-700 transition">Join Now</button>
        </div>
    </section>

    <!-- GUND Section -->
    <section id="gund" aria-label="GUND" class="py-20 px-4 bg-white">
        <div class="max-w-4xl mx-auto text-center">
            <h2 class="text-4xl font-bold mb-6 gradient-text">GUND</h2>
            <p class="text-lg text-gray-700">Through trusted knowledge, innovative tools, and a supportive community.</p>
        </div>
    </section>

    <!-- Contact Section -->
    <section id="contact" aria-label="Contact" class="py-20 px-4 bg-gray-100">
        <div class="max-w-2xl mx-auto">
            <h2 class="text-4xl font-bold mb-12 text-center gradient-text">Contact Us</h2>
            <form class="bg-white rounded-lg p-8 shadow-md" onsubmit="handleContactSubmit(event)">
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">Name</label>
                    <input type="text" placeholder="Your Name" class="w-full border border-gray-300 rounded px-4 py-2 focus:outline-none focus:border-purple-600" required>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">Email</label>
                    <input type="email" placeholder="Your Email" class="w-full border border-gray-300 rounded px-4 py-2 focus:outline-none focus:border-purple-600" required>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">Message</label>
                    <textarea placeholder="Your Message" rows="4" class="w-full border border-gray-300 rounded px-4 py-2 focus:outline-none focus:border-purple-600" required></textarea>
                </div>
                <button type="submit" class="w-full bg-purple-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-purple-700 transition">Send Message</button>
            </form>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-slate-900 text-white py-8 px-4">
        <div class="max-w-7xl mx-auto text-center">
            <p>&copy; 2024 SmartInvest Africa. All rights reserved.</p>
        </div>
    </footer>

<script>
    let loading = false;
    let paymentMessage = "";

    function scrollToSection(sectionId) {
        const element = document.getElementById(sectionId);
        if (element) {
            element.scrollIntoView({ behavior: 'smooth' });
        }
    }

    async function handleMpesaPay() {
        if (loading) return;
        loading = true;
        const btn = document.getElementById('mpesaBtn');
        const msgDiv = document.getElementById('paymentMessage');
        btn.disabled = true;
        btn.textContent = 'Processing...';
        msgDiv.textContent = '';

        try {
            const phone = btn.dataset.phone || '254114383762';
            const res = await fetch('/api/pay/mpesa', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ amount: 1000, phone })
            });
            const data = await res.json();
            msgDiv.textContent = data.success ? 'M-Pesa STK Push sent. Complete payment on your phone.' : 'M-Pesa payment failed.';
            msgDiv.className = data.success ? 'mt-4 text-sm text-green-300' : 'mt-4 text-sm text-red-300';
        } catch (error) {
            msgDiv.textContent = 'Network error. Please try again.';
            msgDiv.className = 'mt-4 text-sm text-red-300';
        } finally {
            loading = false;
            btn.disabled = false;
            btn.textContent = 'Pay with M-Pesa';
        }
    }

    async function handleBuyMpesa(fileId) {
        if (loading) return;
        loading = true;
        const btn = document.getElementById('mpesaBtn');
        const msgDiv = document.getElementById('paymentMessage');
        btn.disabled = true;
        btn.textContent = 'Processing...';
        msgDiv.textContent = '';
        try {
            const phone = btn.dataset.phone || '254114383762';
            const res = await fetch('/api/pay/mpesa', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ amount: 1000, phone, accountReference: fileId })
            });
            const data = await res.json();
            msgDiv.textContent = data.success ? 'M-Pesa STK Push sent. Complete payment on your phone.' : 'M-Pesa payment failed.';
            msgDiv.className = data.success ? 'mt-4 text-sm text-green-300' : 'mt-4 text-sm text-red-300';
        } catch (error) {
            msgDiv.textContent = 'Network error. Please try again.';
            msgDiv.className = 'mt-4 text-sm text-red-300';
        } finally {
            loading = false;
            btn.disabled = false;
            btn.textContent = 'Pay with M-Pesa';
        }
    }

    async function handlePayPalPay() {
        if (loading) return;
        loading = true;
        const btn = document.getElementById('paypalBtn');
        const msgDiv = document.getElementById('paymentMessage');
        btn.disabled = true;
        btn.textContent = 'Processing...';
        msgDiv.textContent = '';

        try {
            const res = await fetch('/api/pay/paypal/create-order', {
                method: 'POST'
            });
            const data = await res.json();
            if (data?.approveUrl) {
                window.location.href = data.approveUrl;
            } else {
                msgDiv.textContent = 'PayPal order creation failed.';
                msgDiv.className = 'mt-4 text-sm text-red-300';
            }
        } catch (error) {
            msgDiv.textContent = 'Network error. Please try again.';
            msgDiv.className = 'mt-4 text-sm text-red-300';
        } finally {
            loading = false;
            btn.disabled = false;
            btn.textContent = 'Pay with PayPal';
        }
    }

    async function handleBuyPaypal(fileId, amount) {
        if (loading) return;
        loading = true;
        const btn = document.getElementById('paypalBtn');
        const msgDiv = document.getElementById('paymentMessage');
        btn.disabled = true;
        btn.textContent = 'Processing...';
        msgDiv.textContent = '';
        try {
            const res = await fetch('/api/pay/paypal/create-order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ amount: amount || 10, fileId })
            });
            const data = await res.json();
            if (data?.approveUrl) {
                window.location.href = data.approveUrl;
            } else {
                msgDiv.textContent = 'PayPal order creation failed.';
                msgDiv.className = 'mt-4 text-sm text-red-300';
            }
        } catch (error) {
            msgDiv.textContent = 'Network error. Please try again.';
            msgDiv.className = 'mt-4 text-sm text-red-300';
        } finally {
            loading = false;
            btn.disabled = false;
            btn.textContent = 'Pay with PayPal';
        }
    }

    function toggleBankForm(show) {
        const el = document.getElementById('bankForm');
        if (!el) return;
        el.style.display = show ? 'block' : 'none';
        document.getElementById('paymentMessage').textContent = '';
    }

    async function submitBankTransfer(event) {
        event.preventDefault();
        const name = document.getElementById('bankName').value;
        const email = document.getElementById('bankEmail').value;
        const amount = document.getElementById('bankAmount').value;
        const reference = document.getElementById('bankReference').value;
        const msgDiv = document.getElementById('bankInstructions');
        msgDiv.textContent = 'Recording transfer...';
        try {
            const res = await fetch('/api/pay/kcb/manual', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, email, amount, reference })
            });
            const data = await res.json();
            if (data.success && data.transaction) {
                const acc = data.transaction.account;
                msgDiv.innerHTML = `<div>Please pay <strong>KES ${data.transaction.amount}</strong> to:</div>
                    <div class="mt-2"><strong>${acc.bank}</strong> — ${acc.accountName}</div>
                    <div>${acc.accountNumber}</div>
                    <div class="mt-2 text-sm text-gray-600">Use reference: <strong>${data.transaction.reference || data.transaction.timestamp}</strong></div>
                    <div class="mt-2 text-sm text-gray-600">After sending funds, email a proof to <strong>${data.transaction.email}</strong> with the reference.</div>`;
                document.getElementById('bankForm').style.display = 'block';
            } else {
                msgDiv.textContent = 'Failed to record transfer. Try again.';
            }
        } catch (err) {
            msgDiv.textContent = 'Network error. Please try again.';
        }
    }

    function openBankForFile(fileId) {
        toggleBankForm(true);
        document.getElementById('bankReference').value = fileId;
    }

    function handleContactSubmit(event) {
        event.preventDefault();
        alert('Thank you for your message! We will get back to you soon.');
        event.target.reset();
    }

    async function demoLogin(event) {
        event.preventDefault();
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        
        try {
            const res = await fetch('/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            const data = await res.json();
            
            if (data.success && data.token) {
                localStorage.setItem('si_auth_token', data.token);
                localStorage.setItem('si_user_email', email.toLowerCase());
                localStorage.setItem('si_is_admin', data.admin ? 'true' : 'false');
                
                alert('Sign in successful');
                event.target.reset();
                
                if (data.admin) {
                    document.getElementById('admin-section').style.display = 'block';
                }
            } else {
                alert('Sign in failed: ' + (data.error || 'Invalid credentials'));
            }
        } catch (e) {
            alert('Network error');
        }
    }

    function authHeaders() {
        const token = localStorage.getItem('si_auth_token');
        // Validate token format (should be JWT with 3 parts separated by dots)
        if (token && typeof token === 'string' && token.split('.').length === 3) {
            return { 'Authorization': `Bearer ${token}` };
        }
        return {};
    }

    function handleLogout() {
        localStorage.removeItem('si_auth_token');
        localStorage.removeItem('si_user_email');
        localStorage.removeItem('si_is_admin');
        document.getElementById('admin-section').style.display = 'none';
        alert('Logged out successfully');
    }

    function checkAdminAccess() {
        const isAdmin = localStorage.getItem('si_is_admin') === 'true';
        const token = localStorage.getItem('si_auth_token');
        if (isAdmin && token) {
            document.getElementById('admin-section').style.display = 'block';
        }
    }

    async function handleSignup(event) {
        event.preventDefault();
        const email = document.getElementById('signupEmail').value;
        const password = document.getElementById('signupPassword').value;
        const acceptTerms = document.getElementById('acceptTerms').checked;
        try {
            const res = await fetch('/api/auth/signup', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password, acceptTerms }) });
            const data = await res.json();
            if (data.success) {
                alert('Signup successful — you can now sign in.');
                try { localStorage.setItem('si_user_email', email.toLowerCase()); } catch (e) {}
                event.target.reset();
            } else {
                alert('Signup failed: ' + (data.error||''));
            }
        } catch (err) {
            alert('Network error');
        }
    }

    // Fetch public catalog and render into #catalog
    async function fetchCatalog() {
        try {
            const res = await fetch('/api/catalog');
            const data = await res.json();
            const el = document.getElementById('catalog');
            if (!data.success || !Array.isArray(data.files)) {
                el.innerHTML = '<div class="col-span-3 text-center text-red-500">Failed to load catalog.</div>';
                return;
            }
            if (data.files.length === 0) {
                el.innerHTML = '<div class="col-span-3 text-center text-gray-500">No files available.</div>';
                return;
            }
            el.innerHTML = '';
            data.files.forEach(f => {
                const card = document.createElement('div');
                card.className = 'bg-white border border-gray-200 rounded-lg p-6 shadow-sm';
                card.innerHTML = `<h3 class="text-xl font-bold mb-2 text-purple-600">${escapeHtml(f.title)}</h3>
                    <p class="text-gray-600 mb-3">${escapeHtml(f.description || '')}</p>
                    <div class="mb-4 font-semibold">Price: ${escapeHtml(String(f.price || 0))} USD</div>
                    <div class="flex gap-2">
                        <button class="flex-1 bg-blue-500 text-white px-4 py-2 rounded" onclick="handleBuyPaypal('${f.id}', ${Number(f.price || 10)})">Buy with PayPal</button>
                        <button class="bg-green-500 text-white px-4 py-2 rounded" onclick="handleBuyMpesa('${f.id}')">Pay M-Pesa</button>
                        <button class="bg-gray-800 text-white px-4 py-2 rounded" onclick="openBankForFile('${f.id}')">Bank</button>
                    </div>`;
                el.appendChild(card);
            });
        } catch (e) {
            const el = document.getElementById('catalog');
            if (el) el.innerHTML = '<div class="col-span-3 text-center text-red-500">Error loading catalog.</div>';
        }
    }

    function escapeHtml(s) { return String(s).replace(/[&<>"'`]/g, function(c){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;","`":"&#96;"}[c]; }); }

    // When requesting download tokens, include purchaser email header if available
    async function requestDownloadToken(fileId) {
        const email = localStorage.getItem('si_user_email');
        const body = { fileId, email };
        const headers = { 'Content-Type': 'application/json' };
        if (email) headers['x-user-email'] = email;
        const res = await fetch('/api/download/request', { method: 'POST', headers, body: JSON.stringify(body) });
        return res.json();
    }

    // Load catalog on page ready
    try { 
        window.addEventListener('load', fetchCatalog);
        window.addEventListener('load', checkAdminAccess);
    } catch (e) {}
</script>
<!-- Sign In Section -->
<section id="signin" aria-label="Sign In" class="py-20 px-4 bg-white">
  <div class="max-w-md mx-auto bg-gray-50 p-8 rounded-lg shadow-md">
    <h2 class="text-3xl font-bold mb-6 text-center text-purple-600">Sign In</h2>

    <form onsubmit="demoLogin(event)" class="space-y-4">
      <input
        id="loginEmail"
        type="email"
        placeholder="Email"
        required
        class="w-full border border-gray-300 rounded px-4 py-2 focus:outline-none focus:border-purple-600"
      />

      <input
        id="loginPassword"
        type="password"
        placeholder="Password"
        required
        class="w-full border border-gray-300 rounded px-4 py-2 focus:outline-none focus:border-purple-600"
      />

            <button type="submit" class="w-full bg-purple-600 text-white py-2 rounded-lg font-semibold hover:bg-purple-700 transition">Sign In</button>
    </form>

        <hr class="my-6">

        <h3 class="text-xl font-semibold mb-4 text-center">Create an account</h3>
        <form id="signupForm" onsubmit="handleSignup(event)" class="space-y-4">
            <input id="signupEmail" type="email" placeholder="Email" required class="w-full border border-gray-300 rounded px-4 py-2 focus:outline-none focus:border-purple-600" />
            <input id="signupPassword" type="password" placeholder="Password" required class="w-full border border-gray-300 rounded px-4 py-2 focus:outline-none focus:border-purple-600" />
            <div class="flex items-start gap-2">
                <input id="acceptTerms" type="checkbox" class="mt-1" />
                <label for="acceptTerms" class="text-sm">I agree to the <a href="/terms.html" class="text-purple-600 underline">Terms & Conditions</a> and acknowledge SmartInvest is not responsible for inconveniences encountered prior to signup.</label>
            </div>
            <button type="submit" class="w-full bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">Sign Up</button>
        </form>

    <p class="text-center text-sm text-gray-500 mt-4">
      Sign in with your credentials
    </p>
  </div>
</section>

<!-- Admin Section -->
<section id="admin-section" aria-label="Admin Dashboard" class="py-20 px-4 bg-gray-100" style="display:none;">
  <div class="max-w-6xl mx-auto">
    <!-- Header -->
    <div class="bg-white p-6 rounded shadow mb-4">
      <div class="flex justify-between items-center">
        <div>
          <h1 class="text-3xl font-bold">Admin Dashboard</h1>
          <p class="text-gray-600">Manage users, payments, files, messages, and premium access</p>
        </div>
        <button onclick="handleLogout()" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Logout</button>
      </div>
    </div>

    <!-- Tabs Navigation -->
    <div class="flex gap-2 mb-4 flex-wrap bg-white p-2 rounded shadow">
      <button class="admin-tab-btn active" onclick="switchAdminTab('dashboard')">Dashboard</button>
      <button class="admin-tab-btn" onclick="switchAdminTab('users')">Users & Sessions</button>
      <button class="admin-tab-btn" onclick="switchAdminTab('premium')">Premium Access</button>
      <button class="admin-tab-btn" onclick="switchAdminTab('files')">File Manager</button>
      <button class="admin-tab-btn" onclick="switchAdminTab('messages')">Support Messages</button>
      <button class="admin-tab-btn" onclick="switchAdminTab('payments')">Payments</button>
      <button class="admin-tab-btn" onclick="switchAdminTab('email')">Email Tools</button>
    </div>

    <!-- Dashboard Tab -->
    <div id="admin-dashboard" class="admin-tab-content active bg-white p-6 rounded shadow mb-4">
      <h2 class="text-2xl font-bold mb-4">Dashboard Overview</h2>
      <div class="grid grid-cols-4 gap-4">
        <div class="bg-blue-50 p-4 rounded border">
          <div class="text-gray-600 text-sm">Total Users</div>
          <div id="admin-stat-users" class="text-3xl font-bold">-</div>
        </div>
        <div class="bg-green-50 p-4 rounded border">
          <div class="text-gray-600 text-sm">Premium Users</div>
          <div id="admin-stat-premium" class="text-3xl font-bold">-</div>
        </div>
        <div class="bg-purple-50 p-4 rounded border">
          <div class="text-gray-600 text-sm">Files Uploaded</div>
          <div id="admin-stat-files" class="text-3xl font-bold">-</div>
        </div>
        <div class="bg-orange-50 p-4 rounded border">
          <div class="text-gray-600 text-sm">Pending Messages</div>
          <div id="admin-stat-messages" class="text-3xl font-bold">-</div>
        </div>
      </div>
      <button onclick="refreshAdminDashboard()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded">Refresh Stats</button>
    </div>

    <!-- Users & Sessions Tab -->
    <div id="admin-users" class="admin-tab-content bg-white p-6 rounded shadow mb-4">
      <h2 class="text-2xl font-bold mb-4">Users & Active Sessions</h2>
      
      <div class="mb-4">
        <h3 class="font-semibold mb-2">Registered Users</h3>
        <div class="flex gap-2 mb-2">
          <input type="text" id="admin-userSearch" placeholder="Search by email or name..." class="flex-1 border rounded p-2">
          <button onclick="searchAdminUsers()" class="bg-blue-600 text-white px-4 py-2 rounded">Search</button>
          <button onclick="loadAllAdminUsers()" class="bg-gray-600 text-white px-4 py-2 rounded">Load All</button>
        </div>
        <div id="admin-usersList" class="text-sm text-gray-600">Click "Load All" to view users...</div>
      </div>

      <div class="mb-4 border-t pt-4">
        <h3 class="font-semibold mb-2">Active Sessions</h3>
        <div id="admin-sessionsList" class="text-sm text-gray-600">Loading sessions...</div>
        <button onclick="loadAdminActiveSessions()" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded">Refresh Sessions</button>
      </div>
    </div>

    <!-- Premium Access Tab -->
    <div id="admin-premium" class="admin-tab-content bg-white p-6 rounded shadow mb-4">
      <h2 class="text-2xl font-bold mb-4">Grant Premium Access</h2>
      
      <div class="mb-4 border p-4 rounded bg-blue-50">
        <h3 class="font-semibold mb-2">Grant Premium to User</h3>
        <div class="grid grid-cols-2 gap-2">
          <input type="email" id="admin-premiumEmail" placeholder="User email" class="border rounded p-2">
          <input type="number" id="admin-premiumDays" placeholder="Days of access" class="border rounded p-2" value="30">
          <input type="text" id="admin-premiumReason" placeholder="Reason (optional)" class="col-span-2 border rounded p-2">
          <button onclick="grantAdminPremiumAccess()" class="col-span-2 bg-green-600 text-white px-4 py-2 rounded">Grant Premium</button>
        </div>
        <div id="admin-premiumStatus" class="text-sm mt-2"></div>
      </div>

      <div class="border p-4 rounded">
        <h3 class="font-semibold mb-2">Revoke Premium Access</h3>
        <div class="flex gap-2">
          <input type="email" id="admin-revokeEmail" placeholder="User email" class="flex-1 border rounded p-2">
          <button onclick="revokeAdminPremiumAccess()" class="bg-red-600 text-white px-4 py-2 rounded">Revoke</button>
        </div>
        <div id="admin-revokeStatus" class="text-sm mt-2"></div>
      </div>
    </div>

    <!-- File Manager Tab -->
    <div id="admin-files" class="admin-tab-content bg-white p-6 rounded shadow mb-4">
      <h2 class="text-2xl font-bold mb-4">File Manager</h2>
      
      <div class="mb-4 border p-4 rounded bg-gray-50">
        <h3 class="font-semibold mb-2">Upload File</h3>
        <form onsubmit="uploadAdminFile(event)" class="space-y-2">
          <input type="text" id="admin-fileTitle" placeholder="File title" class="w-full border rounded p-2" required>
          <input type="number" id="admin-filePrice" placeholder="Price (USD)" class="w-full border rounded p-2" step="0.01" value="0">
          <textarea id="admin-fileDescription" placeholder="Description (optional)" class="w-full border rounded p-2 h-20"></textarea>
          <input type="file" id="admin-fileInput" class="w-full border rounded p-2" required>
          <button type="submit" class="w-full bg-blue-600 text-white px-4 py-2 rounded">Upload</button>
        </form>
        <div id="admin-uploadStatus" class="text-sm mt-2"></div>
      </div>

      <div class="border p-4 rounded">
        <h3 class="font-semibold mb-2">Files Library</h3>
        <div class="flex gap-2 mb-2">
          <button onclick="loadAdminFiles()" class="bg-blue-600 text-white px-4 py-2 rounded">Load Files</button>
          <button onclick="exportAdminFilesList()" class="bg-green-600 text-white px-4 py-2 rounded">Export List</button>
        </div>
        <div id="admin-filesList" class="text-sm text-gray-600 max-h-96 overflow-y-auto">Click "Load Files" to view...</div>
      </div>
    </div>

    <!-- Support Messages Tab -->
    <div id="admin-messages" class="admin-tab-content bg-white p-6 rounded shadow mb-4">
      <h2 class="text-2xl font-bold mb-4">Support Messages & Chat</h2>
      
      <div class="flex gap-2 mb-4">
        <button onclick="loadAdminMessages()" class="bg-blue-600 text-white px-4 py-2 rounded">Load Messages</button>
        <button onclick="refreshAdminMessages()" class="bg-gray-600 text-white px-4 py-2 rounded">Refresh</button>
      </div>

      <div id="admin-messagesList" class="space-y-3 max-h-96 overflow-y-auto">
        <div class="text-gray-600 text-sm">Click "Load Messages" to view support tickets...</div>
      </div>
    </div>

    <!-- Payments Tab -->
    <div id="admin-payments" class="admin-tab-content bg-white p-6 rounded shadow mb-4">
      <h2 class="text-2xl font-bold mb-4">Payment Management</h2>
      
      <div class="mb-4">
        <h3 class="font-semibold mb-2">KCB Manual Transfers</h3>
        <div id="admin-kcbTransfersList" class="text-sm text-gray-600 max-h-96 overflow-y-auto">Loading transfers...</div>
        <button onclick="loadAdminKCBTransfers()" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded">Load Transfers</button>
        <button onclick="exportAdminKCBCSV()" class="mt-2 bg-green-600 text-white px-4 py-2 rounded">Export CSV</button>
      </div>

      <div class="border-t pt-4">
        <h3 class="font-semibold mb-2">Reconcile Bank Entries</h3>
        <textarea id="admin-reconcileData" placeholder="Paste JSON array of bank entries..." class="w-full border rounded p-2 h-24"></textarea>
        <div class="flex gap-2 mt-2">
          <button onclick="reconcileAdminBankEntries()" class="bg-green-600 text-white px-4 py-2 rounded">Reconcile</button>
          <button onclick="document.getElementById('admin-reconcileData').value=''" class="bg-gray-400 text-white px-4 py-2 rounded">Clear</button>
        </div>
        <div id="admin-reconcileResult" class="text-sm mt-2 text-gray-600"></div>
      </div>

      <div class="border-t pt-4 mt-4">
        <h3 class="font-semibold mb-2">Request Payment Review</h3>
        <p class="text-sm text-gray-600 mb-2">For payments where automatic acceptance failed</p>
        <div class="flex gap-2">
          <input type="text" id="admin-paymentId" placeholder="Payment ID or Transaction ID" class="flex-1 border rounded p-2">
          <button onclick="requestAdminPaymentReview()" class="bg-orange-600 text-white px-4 py-2 rounded">Request Review</button>
        </div>
        <div id="admin-reviewStatus" class="text-sm mt-2"></div>
      </div>
    </div>

    <!-- Email Tools Tab -->
    <div id="admin-email" class="admin-tab-content bg-white p-6 rounded shadow mb-4">
      <h2 class="text-2xl font-bold mb-4">Email Tools</h2>
      
      <div class="mb-4 border p-4 rounded bg-blue-50">
        <h3 class="font-semibold mb-2">Send Email to User</h3>
        <div class="space-y-2">
          <input type="email" id="admin-emailTo" placeholder="Recipient email" class="w-full border rounded p-2" required>
          <input type="text" id="admin-emailSubject" placeholder="Subject" class="w-full border rounded p-2" required>
          <textarea id="admin-emailBody" placeholder="Email body (HTML or plain text)" class="w-full border rounded p-2 h-32" required></textarea>
          <button onclick="sendAdminEmail()" class="w-full bg-blue-600 text-white px-4 py-2 rounded">Send Email</button>
        </div>
        <div id="admin-emailStatus" class="text-sm mt-2"></div>
      </div>

      <div class="border p-4 rounded">
        <h3 class="font-semibold mb-2">Send Bulk Email</h3>
        <div class="space-y-2">
          <input type="text" id="admin-bulkSubject" placeholder="Subject" class="w-full border rounded p-2" required>
          <textarea id="admin-bulkBody" placeholder="Email body" class="w-full border rounded p-2 h-24" required></textarea>
          <select id="admin-bulkRecipients" class="w-full border rounded p-2">
            <option value="">-- Select Recipients --</option>
            <option value="all-users">All Users</option>
            <option value="premium-users">Premium Users Only</option>
            <option value="free-users">Free Users Only</option>
            <option value="inactive">Inactive Users (7+ days)</option>
          </select>
          <button onclick="sendAdminBulkEmail()" class="w-full bg-green-600 text-white px-4 py-2 rounded">Send Bulk Email</button>
        </div>
        <div id="admin-bulkStatus" class="text-sm mt-2"></div>
      </div>
    </div>
  </div>
</section>

<!-- Footer -->
<footer class="bg-slate-900 text-white py-8 px-4">
    <div class="max-w-7xl mx-auto text-center">
        <p>&copy; 2024 SmartInvest Africa. All rights reserved.</p>
    </div>
</footer>

<style>
  .admin-tab-content { display: none; }
  .admin-tab-content.active { display: block; }
  .admin-tab-btn { padding: 0.5rem 1rem; border: none; background: #e5e7eb; cursor: pointer; border-radius: 0.25rem; }
  .admin-tab-btn.active { background: #2563eb; color: white; }
</style>

<script>
  function switchAdminTab(tabName) {
    document.querySelectorAll('.admin-tab-content').forEach(t => t.classList.remove('active'));
    document.getElementById('admin-' + tabName).classList.add('active');
    
    document.querySelectorAll('.admin-tab-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    
    if (tabName === 'dashboard') refreshAdminDashboard();
    if (tabName === 'users') loadAllAdminUsers();
    if (tabName === 'messages') loadAdminMessages();
    if (tabName === 'payments') loadAdminKCBTransfers();
  }

  async function refreshAdminDashboard() {
    try {
      const res = await fetch('/api/admin/dashboard-stats', { headers: authHeaders() });
      if (res.ok) {
        const data = await res.json();
        document.getElementById('admin-stat-users').textContent = data.totalUsers || '0';
        document.getElementById('admin-stat-premium').textContent = data.premiumUsers || '0';
        document.getElementById('admin-stat-files').textContent = data.filesCount || '0';
        document.getElementById('admin-stat-messages').textContent = data.pendingMessages || '0';
      }
    } catch (e) {
      console.error('Dashboard error:', e);
    }
  }

  async function loadAllAdminUsers() {
    try {
      const res = await fetch('/api/admin/users', { headers: authHeaders() });
      const data = await res.json();
      const list = document.getElementById('admin-usersList');
      
      if (!data.success || !data.users.length) {
        list.innerHTML = '<div class="text-gray-600">No users found.</div>';
        return;
      }

      const rows = data.users.map(u => `
        <div class="border rounded p-2 mb-2">
          <div class="flex justify-between items-start">
            <div>
              <strong>${u.name || 'N/A'}</strong><br>
              <small class="text-gray-600">${u.email}</small><br>
              <small class="text-xs text-gray-500">Registered: ${u.createdAt || 'N/A'}</small>
            </div>
            <div class="text-right">
              <span class="text-xs bg-${u.isPremium ? 'green' : 'gray'}-100 px-2 py-1 rounded">${u.isPremium ? 'Premium' : 'Free'}</span>
            </div>
          </div>
        </div>
      `).join('');

      list.innerHTML = rows;
    } catch (e) {
      document.getElementById('admin-usersList').innerHTML = '<div class="text-red-600">Error loading users</div>';
    }
  }

  async function searchAdminUsers() {
    const email = document.getElementById('admin-userSearch').value;
    if (!email) return alert('Enter email to search');
    
    try {
      const res = await fetch(`/api/admin/users?search=${encodeURIComponent(email)}`, { headers: authHeaders() });
      const data = await res.json();
      const list = document.getElementById('admin-usersList');
      
      if (!data.users.length) {
        list.innerHTML = '<div class="text-gray-600">No users found.</div>';
        return;
      }

      const rows = data.users.map(u => `
        <div class="border rounded p-2 mb-2">
          <strong>${u.name || 'N/A'}</strong> - ${u.email}
          <div class="text-xs text-gray-600 mt-1">Status: ${u.isPremium ? 'Premium' : 'Free'}</div>
        </div>
      `).join('');

      list.innerHTML = rows;
    } catch (e) {
      alert('Search error: ' + e.message);
    }
  }

  async function loadAdminActiveSessions() {
    try {
      const res = await fetch('/api/admin/sessions', { headers: authHeaders() });
      const data = await res.json();
      const list = document.getElementById('admin-sessionsList');
      
      if (!data.success || !data.sessions.length) {
        list.innerHTML = '<div class="text-gray-600">No active sessions.</div>';
        return;
      }

      const rows = data.sessions.map(s => `
        <div class="border rounded p-2 mb-2 text-sm">
          <strong>${s.userEmail}</strong><br>
          <small class="text-gray-600">IP: ${s.ip || 'N/A'} | Last: ${s.lastActivity || 'N/A'}</small>
        </div>
      `).join('');

      list.innerHTML = rows;
    } catch (e) {
      document.getElementById('admin-sessionsList').innerHTML = '<div class="text-red-600">Error loading sessions</div>';
    }
  }

  async function grantAdminPremiumAccess() {
    const email = document.getElementById('admin-premiumEmail').value;
    const days = parseInt(document.getElementById('admin-premiumDays').value) || 30;
    const reason = document.getElementById('admin-premiumReason').value;

    if (!email) return alert('Enter email');

    try {
      const res = await fetch('/api/admin/grant-premium', {
        method: 'POST',
        headers: { ...authHeaders(), 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, days, reason })
      });

      const data = await res.json();
      const status = document.getElementById('admin-premiumStatus');

      if (data.success) {
        status.textContent = `✓ Premium granted to ${email} for ${days} days`;
        status.className = 'text-sm text-green-600 mt-2';
        document.getElementById('admin-premiumEmail').value = '';
        document.getElementById('admin-premiumDays').value = '30';
        document.getElementById('admin-premiumReason').value = '';
      } else {
        status.textContent = '✗ Error: ' + (data.error || 'Failed');
        status.className = 'text-sm text-red-600 mt-2';
      }
    } catch (e) {
      alert('Error: ' + e.message);
    }
  }

  async function revokeAdminPremiumAccess() {
    const email = document.getElementById('admin-revokeEmail').value;
    if (!email) return alert('Enter email');

    if (!confirm('Revoke premium for ' + email + '?')) return;

    try {
      const res = await fetch('/api/admin/revoke-premium', {
        method: 'POST',
        headers: { ...authHeaders(), 'Content-Type': 'application/json' },
        body: JSON.stringify({ email })
      });

      const data = await res.json();
      const status = document.getElementById('admin-revokeStatus');

      if (data.success) {
        status.textContent = `✓ Premium revoked for ${email}`;
        status.className = 'text-sm text-green-600 mt-2';
        document.getElementById('admin-revokeEmail').value = '';
      } else {
        status.textContent = '✗ Error: ' + (data.error || 'Failed');
        status.className = 'text-sm text-red-600 mt-2';
      }
    } catch (e) {
      alert('Error: ' + e.message);
    }
  }

  async function uploadAdminFile(e) {
    e.preventDefault();

    const title = document.getElementById('admin-fileTitle').value;
    const price = document.getElementById('admin-filePrice').value;
    const description = document.getElementById('admin-fileDescription').value;
    const fileInput = document.getElementById('admin-fileInput');

    if (!fileInput.files.length) return alert('Select a file');

    const fd = new FormData();
    fd.append('file', fileInput.files[0]);
    fd.append('title', title);
    fd.append('price', price);
    fd.append('description', description);

    try {
      const res = await fetch('/api/admin/files/upload', {
        method: 'POST',
        headers: authHeaders(),
        body: fd
      });

      const data = await res.json();
      const status = document.getElementById('admin-uploadStatus');

      if (data.success) {
        status.textContent = '✓ File uploaded successfully';
        status.className = 'text-sm text-green-600';
        document.getElementById('admin-fileTitle').value = '';
        document.getElementById('admin-filePrice').value = '0';
        document.getElementById('admin-fileDescription').value = '';
        fileInput.value = '';
        setTimeout(loadAdminFiles, 1000);
      } else {
        status.textContent = '✗ Upload failed: ' + (data.error || '');
        status.className = 'text-sm text-red-600';
      }
    } catch (e) {
      document.getElementById('admin-uploadStatus').textContent = '✗ Error: ' + e.message;
      document.getElementById('admin-uploadStatus').className = 'text-sm text-red-600';
    }
  }

  async function loadAdminFiles() {
    try {
      const res = await fetch('/api/admin/files', { headers: authHeaders() });
      const data = await res.json();
      const list = document.getElementById('admin-filesList');

      if (!data.success || !data.files.length) {
        list.innerHTML = '<div class="text-gray-600">No files uploaded.</div>';
        return;
      }

      const rows = data.files.map(f => `
        <div class="border rounded p-2 mb-2">
          <div class="flex justify-between items-start">
            <div>
              <strong>${f.title}</strong><br>
              <small class="text-gray-600">Price: $${f.price}</small><br>
              <small class="text-xs text-gray-500">${f.originalName}</small>
            </div>
            <div class="space-x-1">
              <button onclick="toggleAdminPublish('${f.id}',${f.published})" class="bg-gray-500 text-white px-2 py-1 rounded text-xs">${f.published ? 'Unpublish' : 'Publish'}</button>
              <button onclick="deleteAdminFile('${f.id}')" class="bg-red-600 text-white px-2 py-1 rounded text-xs">Delete</button>
            </div>
          </div>
        </div>
      `).join('');

      list.innerHTML = rows;
    } catch (e) {
      document.getElementById('admin-filesList').innerHTML = '<div class="text-red-600">Error loading files</div>';
    }
  }

  async function toggleAdminPublish(id, current) {
    try {
      const res = await fetch(`/api/admin/files/${id}`, {
        method: 'POST',
        headers: { ...authHeaders(), 'Content-Type': 'application/json' },
        body: JSON.stringify({ published: !current })
      });

      const data = await res.json();
      if (data.success) loadAdminFiles();
    } catch (e) {
      alert('Error: ' + e.message);
    }
  }

  async function deleteAdminFile(id) {
    if (!confirm('Delete this file?')) return;

    try {
      const res = await fetch(`/api/admin/files/${id}`, { 
        method: 'DELETE',
        headers: authHeaders()
      });
      const data = await res.json();

      if (data.success) {
        alert('File deleted');
        loadAdminFiles();
      } else {
        alert('Error: ' + (data.error || 'Failed'));
      }
    } catch (e) {
      alert('Error: ' + e.message);
    }
  }

  function exportAdminFilesList() {
    alert('Export functionality to be implemented');
  }

  async function loadAdminMessages() {
    try {
      const res = await fetch('/api/admin/messages', { headers: authHeaders() });
      const data = await res.json();
      const list = document.getElementById('admin-messagesList');

      if (!data.success || !data.messages.length) {
        list.innerHTML = '<div class="text-gray-600">No messages.</div>';
        return;
      }

      const rows = data.messages.map(m => `
        <div class="border rounded p-3 bg-gray-50">
          <div class="flex justify-between">
            <div>
              <strong>${m.name}</strong><br>
              <small class="text-gray-600">${m.email}</small>
            </div>
            <small class="text-gray-500">${m.createdAt}</small>
          </div>
          <div class="mt-2 text-sm">${m.message}</div>
          ${(m.replies || []).map(r => `
            <div class="mt-2 p-2 bg-white border-l-4 border-blue-600">
              <strong class="text-blue-600">Admin Reply:</strong><br>
              <small class="text-gray-500">${r.at}</small>
              <div class="text-sm mt-1">${r.message}</div>
            </div>
          `).join('')}
          <div class="mt-2 flex gap-2">
            <input id="admin-reply_${m.id}" type="text" placeholder="Your reply..." class="flex-1 border rounded p-2 text-sm">
            <button onclick="replyAdminMessage('${m.id}')" class="bg-blue-600 text-white px-3 py-1 rounded text-sm">Reply</button>
          </div>
        </div>
      `).join('');

      list.innerHTML = rows;
    } catch (e) {
      document.getElementById('admin-messagesList').innerHTML = '<div class="text-red-600">Error loading messages</div>';
    }
  }

  async function replyAdminMessage(id) {
    const input = document.getElementById(`admin-reply_${id}`);
    const text = input.value.trim();

    if (!text) return alert('Enter a reply');

    try {
      const res = await fetch(`/api/admin/messages/${id}/reply`, {
        method: 'POST',
        headers: { ...authHeaders(), 'Content-Type': 'application/json' },
        body: JSON.stringify({ reply: text })
      });

      const data = await res.json();
      if (data.success) {
        input.value = '';
        loadAdminMessages();
      } else {
        alert('Error: ' + (data.error || 'Failed'));
      }
    } catch (e) {
      alert('Error: ' + e.message);
    }
  }

  function refreshAdminMessages() {
    loadAdminMessages();
  }

  async function loadAdminKCBTransfers() {
    try {
      const res = await fetch('/api/admin/kcb-transfers', { headers: authHeaders() });
      const data = await res.json();
      const list = document.getElementById('admin-kcbTransfersList');

      if (!data.success || !data.transfers.length) {
        list.innerHTML = '<div class="text-gray-600">No transfers found.</div>';
        return;
      }

      const rows = data.transfers.map(t => `
        <div class="border rounded p-2 mb-2 text-sm">
          <div class="flex justify-between">
            <div>
              <strong>${t.name}</strong> (${t.email})<br>
              <small class="text-gray-600">KES ${t.amount} - Ref: ${t.reference || 'N/A'}</small>
            </div>
            <div class="text-right">
              <span class="text-xs bg-${t.status === 'paid' ? 'green' : 'yellow'}-100 px-2 py-1 rounded">${t.status}</span><br>
              <small class="text-gray-500">${t.timestamp}</small>
            </div>
          </div>
          ${t.status !== 'paid' ? `<button onclick="markAdminPaid('${t.timestamp}')" class="mt-1 bg-green-600 text-white px-2 py-1 rounded text-xs">Mark Paid</button>` : ''}
        </div>
      `).join('');

      list.innerHTML = rows;
    } catch (e) {
      document.getElementById('admin-kcbTransfersList').innerHTML = '<div class="text-red-600">Error loading transfers</div>';
    }
  }

  async function markAdminPaid(ts) {
    const note = prompt('Optional note for this transfer:');
    
    try {
      const res = await fetch('/api/admin/kcb/mark-paid', {
        method: 'POST',
        headers: { ...authHeaders(), 'Content-Type': 'application/json' },
        body: JSON.stringify({ timestamp: ts, note })
      });

      const data = await res.json();
      if (data.success) {
        alert('Transfer marked as paid');
        loadAdminKCBTransfers();
      } else {
        alert('Error: ' + (data.error || 'Failed'));
      }
    } catch (e) {
      alert('Error: ' + e.message);
    }
  }

  async function exportAdminKCBCSV() {
    try {
      const res = await fetch('/api/admin/kcb-export', { headers: authHeaders() });
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'kcb-transfers.csv';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    } catch (e) {
      alert('Export failed: ' + e.message);
    }
  }

  async function reconcileAdminBankEntries() {
    const txt = document.getElementById('admin-reconcileData').value.trim();
    if (!txt) return alert('Paste JSON array');

    let arr;
    try {
      arr = JSON.parse(txt);
    } catch (e) {
      return alert('Invalid JSON: ' + e.message);
    }

    try {
      const res = await fetch('/api/admin/kcb/reconcile', {
        method: 'POST',
        headers: { ...authHeaders(), 'Content-Type': 'application/json' },
        body: JSON.stringify({ entries: arr })
      });

      const data = await res.json();
      const result = document.getElementById('admin-reconcileResult');

      if (data.success) {
        result.textContent = `✓ Matched: ${data.summary.matched}, Unmatched: ${data.summary.unmatched}`;
        result.className = 'text-sm text-green-600 mt-2';
        loadAdminKCBTransfers();
      } else {
        result.textContent = '✗ Error: ' + (data.error || '');
        result.className = 'text-sm text-red-600 mt-2';
      }
    } catch (e) {
      alert('Error: ' + e.message);
    }
  }

  async function requestAdminPaymentReview() {
    const paymentId = document.getElementById('admin-paymentId').value.trim();
    if (!paymentId) return alert('Enter payment ID');

    try {
      const res = await fetch('/api/admin/payment-review', {
        method: 'POST',
        headers: { ...authHeaders(), 'Content-Type': 'application/json' },
        body: JSON.stringify({ paymentId })
      });

      const data = await res.json();
      const status = document.getElementById('admin-reviewStatus');

      if (data.success) {
        status.textContent = `✓ Review requested for payment ${paymentId}`;
        status.className = 'text-sm text-green-600';
        document.getElementById('admin-paymentId').value = '';
      } else {
        status.textContent = '✗ Error: ' + (data.error || 'Failed');
        status.className = 'text-sm text-red-600';
      }
    } catch (e) {
      alert('Error: ' + e.message);
    }
  }

  async function sendAdminEmail() {
    const to = document.getElementById('admin-emailTo').value;
    const subject = document.getElementById('admin-emailSubject').value;
    const body = document.getElementById('admin-emailBody').value;

    if (!to || !subject || !body) return alert('Fill all fields');

    try {
      const res = await fetch('/api/admin/send-email', {
        method: 'POST',
        headers: { ...authHeaders(), 'Content-Type': 'application/json' },
        body: JSON.stringify({ to, subject, body })
      });

      const data = await res.json();
      const status = document.getElementById('admin-emailStatus');

      if (data.success) {
        status.textContent = '✓ Email sent to ' + to;
        status.className = 'text-sm text-green-600';
        document.getElementById('admin-emailTo').value = '';
        document.getElementById('admin-emailSubject').value = '';
        document.getElementById('admin-emailBody').value = '';
      } else {
        status.textContent = '✗ Error: ' + (data.error || 'Failed');
        status.className = 'text-sm text-red-600';
      }
    } catch (e) {
      alert('Error: ' + e.message);
    }
  }

  async function sendAdminBulkEmail() {
    const subject = document.getElementById('admin-bulkSubject').value;
    const body = document.getElementById('admin-bulkBody').value;
    const recipients = document.getElementById('admin-bulkRecipients').value;

    if (!subject || !body || !recipients) return alert('Fill all fields');

    try {
      const res = await fetch('/api/admin/send-bulk-email', {
        method: 'POST',
        headers: { ...authHeaders(), 'Content-Type': 'application/json' },
        body: JSON.stringify({ subject, body, recipients })
      });

      const data = await res.json();
      const status = document.getElementById('admin-bulkStatus');

      if (data.success) {
        status.textContent = `✓ Email sent to ${data.sentCount} recipients`;
        status.className = 'text-sm text-green-600';
        document.getElementById('admin-bulkSubject').value = '';
        document.getElementById('admin-bulkBody').value = '';
        document.getElementById('admin-bulkRecipients').value = '';
      } else {
        status.textContent = '✗ Error: ' + (data.error || 'Failed');
        status.className = 'text-sm text-red-600';
      }
    } catch (e) {
      alert('Error: ' + e.message);
    }
  }
</script>

</body>
</html>
