name: Node.js CI/CD

on:
  push:
    branches: [ main, 'copilot/**' ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  test:
    name: Test & Lint
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run syntax check
        run: npm test
      
      - name: Check for security vulnerabilities
        run: npm audit --audit-level=high || true
      
      - name: Lint JavaScript files
        run: |
          echo "Checking JavaScript syntax..."
          find . -name "*.js" -not -path "*/node_modules/*" -exec node -c {} \;
          echo "✓ All JavaScript files have valid syntax"
  
  html-validation:
    name: HTML & Accessibility Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Validate HTML files
        run: |
          npm install -g html-validate
          echo "Validating HTML files..."
          for file in *.html; do
            if [ -f "$file" ]; then
              echo "Checking $file..."
              # Basic HTML structure check
              if ! grep -q "<!doctype html>" "$file" && ! grep -q "<!DOCTYPE html>" "$file"; then
                echo "Warning: $file missing DOCTYPE declaration"
              fi
              if ! grep -q "<html" "$file"; then
                echo "Error: $file missing <html> tag"
                exit 1
              fi
              if ! grep -q "<head>" "$file"; then
                echo "Error: $file missing <head> tag"
                exit 1
              fi
              if ! grep -q "<body" "$file"; then
                echo "Error: $file missing <body> tag"
                exit 1
              fi
            fi
          done
          echo "✓ All HTML files passed basic validation"
      
      - name: Check accessibility
        run: |
          echo "Running accessibility checks..."
          node tools/axe-node-runner.js || echo "Accessibility check completed with warnings"
  
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run security audit
        run: |
          npm audit --audit-level=moderate || true
          echo "Security audit completed"
      
      - name: Check for exposed secrets
        run: |
          echo "Checking for potential secrets..."
          # Check for common secret patterns (excluding .env.example)
          if grep -r -E "(password|secret|api_key|private_key|token).*=.*['\"][^'\"]{8,}" \
            --exclude-dir=node_modules \
            --exclude-dir=.git \
            --exclude=".env.example" \
            --exclude="*.json" \
            --exclude="*.md" \
            . 2>/dev/null; then
            echo "⚠️ Warning: Potential secrets found in code"
          else
            echo "✓ No obvious secrets detected"
          fi
  
  build:
    name: Build Verification
    runs-on: ubuntu-latest
    needs: [test, html-validation]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Verify server can start
        run: |
          timeout 10s node server.js &
          SERVER_PID=$!
          sleep 5
          if ps -p $SERVER_PID > /dev/null; then
            echo "✓ Server started successfully"
            kill $SERVER_PID
            exit 0
          else
            echo "✗ Server failed to start"
            exit 1
          fi
      
      - name: Run acceptance tests
        run: |
          if [ -f "tools/acceptance_test.js" ]; then
            node tools/acceptance_test.js || echo "Acceptance tests completed with warnings"
          else
            echo "No acceptance tests found, skipping..."
          fi

  deploy-preview:
    name: Deploy Preview (Vercel)
    runs-on: ubuntu-latest
    needs: [test, html-validation, security]
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          scope: ${{ secrets.VERCEL_ORG_ID }}
