<!-- Replace the existing demoLogin / signin code with this. This uses an HttpOnly cookie set by server. -->

<!-- Sign In Section (modified) -->
<section id="signin" aria-label="Sign In" class="py-20 px-4 bg-white">
  <div class="max-w-md mx-auto bg-gray-50 p-8 rounded-lg shadow-md">
    <h2 class="text-3xl font-bold mb-6 text-center text-purple-600">Sign In</h2>

    <form id="signinForm" onsubmit="handleLogin(event)" class="space-y-4">
      <input id="loginEmail" type="email" class="w-full border rounded p-2" placeholder="you@example.com" required />
      <input id="loginPassword" type="password" class="w-full border rounded p-2" placeholder="Password" required />
      <div class="flex items-center justify-between">
        <button type="submit" class="bg-purple-600 text-white px-4 py-2 rounded">Sign in</button>
        <button type="button" onclick="handleLogout()" class="text-sm text-gray-600">Sign out</button>
      </div>
    </form>

    <p class="text-sm text-gray-500 mt-3">Or create an account using the sign-up form below.</p>
  </div>
</section>

<script>
  async function handleLogin(e) {
    e.preventDefault();
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    try {
      const res = await fetch('/api/auth/login', {
        method: 'POST',
        credentials: 'include', // important: receive HttpOnly cookie
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
      });
      const data = await res.json();
      if (!data.success) { alert('Sign in failed: ' + (data.error || 'unknown')); return; }
      // server will have set HttpOnly cookie; check session and admin status
      const m = await fetch('/api/auth/me', { credentials: 'include' });
      const me = await m.json();
      if (me.success && me.admin) showAdminPanel();
      else hideAdminPanel();
      alert('Signed in');
    } catch (err) {
      alert('Network error');
    }
  }

  async function handleLogout() {
    await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
    hideAdminPanel();
    alert('Signed out');
  }

  // All privileged fetches should use credentials: 'include' to send HttpOnly cookie
  // Example: requestDownloadToken
  async function requestDownloadToken(fileId) {
    const body = { fileId };
    const res = await fetch('/api/download/request', {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    return res.json();
  }

  // On load: verify session
  window.addEventListener('load', async () => {
    try {
      const meResp = await fetch('/api/auth/me', { credentials: 'include' });
      const me = await meResp.json();
      if (me.success && me.admin) {
        // load or show embedded admin UI
        await loadEmbeddedAdmin(); // loads admin.html into page
        showAdminPanel();
      } else {
        hideAdminPanel();
      }
      // load public catalog regardless
      fetchCatalog();
    } catch (e) {
      // not signed in
      hideAdminPanel();
      fetchCatalog();
    }
  });

  // Embedded admin loader: fetch admin.html and inject its content into a container.
  // This keeps admin.html as fallback (we also keep admin.html file unchanged except modified to use credentials).
  async function loadEmbeddedAdmin() {
    try {
      const res = await fetch('/admin.html', { credentials: 'include' });
      if (!res.ok) return;
      const html = await res.text();
      const container = document.getElementById('embeddedAdminContainer');
      if (!container) {
        // create container near end of body
        const sec = document.createElement('section');
        sec.id = 'adminSection';
        sec.className = 'py-12 px-4 bg-gray-50';
        sec.innerHTML = `<div id="embeddedAdminContainer">${html}</div>`;
        document.body.appendChild(sec);
      } else {
        container.innerHTML = html;
      }
      // Re-execute inline <script> tags in the injected admin html
      const scripts = (container || document).querySelectorAll('#embeddedAdminContainer script');
      scripts.forEach(oldScript => {
        const s = document.createElement('script');
        if (oldScript.src) s.src = oldScript.src;
        else s.textContent = oldScript.textContent;
        document.body.appendChild(s);
      });
    } catch (e) {
      console.warn('embed admin failed', e);
    }
  }

  function showAdminPanel() {
    const section = document.getElementById('adminSection');
    if (section) section.style.display = 'block';
  }
  function hideAdminPanel() {
    const section = document.getElementById('adminSection');
    if (section) section.style.display = 'none';
  }
</script>

<!-- Placeholder for embedded admin -->
<!-- If you prefer the full admin UI in index.html (not via injecting admin.html), we can paste the admin.html content here instead -->
<div id="adminSection" style="display:none"><div id="embeddedAdminContainer"></div></div>